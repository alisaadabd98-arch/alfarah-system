<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>

    <!-- ===== PWA Meta Tags ===== -->
    <meta name="application-name" content="ALFARAH">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ALFARAH">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f1419">
    <meta name="msapplication-TileColor" content="#C9A961">
    <meta name="msapplication-navbutton-color" content="#0f1419">
    <meta name="format-detection" content="telephone=no">

    <!-- ===== PWA Manifest (inline) ===== -->
    <script>
        // Ø¥Ù†Ø´Ø§Ø¡ manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
        const manifest = {
            name: "ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹",
            short_name: "ALFARAH",
            description: "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©",
            start_url: "./",
            display: "standalone",
            orientation: "portrait",
            background_color: "#0f1419",
            theme_color: "#0f1419",
            lang: "ar",
            dir: "rtl",
            icons: [
                {
                    src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='32' fill='%230f1419'/><rect x='16' y='16' width='160' height='160' rx='24' fill='%23C9A961' opacity='0.15'/><text x='96' y='115' text-anchor='middle' font-family='Arial,sans-serif' font-weight='900' font-size='56' fill='%23C9A961'>AL</text></svg>`),
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml," + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='80' fill='%230f1419'/><rect x='40' y='40' width='432' height='432' rx='60' fill='%23C9A961' opacity='0.15'/><text x='256' y='310' text-anchor='middle' font-family='Arial,sans-serif' font-weight='900' font-size='150' fill='%23C9A961'>AL</text></svg>`),
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.addEventListener('DOMContentLoaded', () => {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
        });
    </script>

    <!-- Apple Touch Icon (SVG inline as data URI) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%230f1419'/%3E%3Crect x='10' y='10' width='160' height='160' rx='30' fill='%23C9A961' opacity='0.2'/%3E%3Ctext x='90' y='108' text-anchor='middle' font-family='Arial' font-weight='900' font-size='52' fill='%23C9A961'%3EAL%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230f1419'/%3E%3Ctext x='32' y='42' text-anchor='middle' font-family='Arial' font-weight='900' font-size='22' fill='%23C9A961'%3EAL%3C/text%3E%3C/svg%3E">
    
    <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘              ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ“‹ Ø§Ù„Ø²ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©:
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„: 210 Ø¯Ø§Ø± - 10 Ø¨Ù„ÙˆÙƒØ§Øª
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ: 148 Ø¯Ø§Ø± - 10 Ø¨Ù„ÙˆÙƒØ§Øª
       â€¢ Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³: 289 Ø¯Ø§Ø± - 13 Ø¨Ù„ÙˆÙƒ
    
    ğŸ”§ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©: 11 Ø¹Ù…Ù„
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©: 9 Ø£Ø¹Ù…Ø§Ù„
       â€¢ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©: 9 Ø£Ø¹Ù…Ø§Ù„
    
    ğŸ‘¥ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:
       â€¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (admin): ali / 112123
       â€¢ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (manager): Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
       â€¢ Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹ (engineer): ØªØ®ØµØµ ÙˆØ§Ø­Ø¯ + Ø²ÙˆÙ†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© + Ø¨Ù„ÙˆÙƒØ§Øª Ù…Ø­Ø¯Ø¯Ø© + Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø§Ø±ÙŠØ±
    
    ğŸ¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†:
       ğŸ”´ Ø£Ø­Ù…Ø± = Ù„Ù… ÙŠØ¨Ø¯Ø£
       ğŸŸ¡ Ø£ØµÙØ± = Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
       ğŸŸ¢ Ø£Ø®Ø¶Ø± = Ù…Ù†Ø¬Ø²
    
    â° Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª:
       â€¢ Ø£ÙˆÙ„ Ø³Ø§Ø¹Ø©: ØªØºÙŠÙŠØ± Ù…Ø¨Ø§Ø´Ø±
       â€¢ Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©: Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±
    
    â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:
       â€¢ JSONBin API
       â€¢ Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
       â€¢ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª CSV
    
    ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:
       â€¢ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ (3 Ø¹ØµØ±Ø§Ù‹)
       â€¢ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠØ©
       â€¢ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
       â€¢ Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±
    
    ğŸ” Ù…Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:
       â€¢ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ø±
       â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
       â€¢ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
       â€¢ Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø£Ù†Ø´Ø·Ø©
    -->
    
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        :root {
            --primary-gold: #C9A961;
            --dark-blue: #1a3a52;
            --darker-blue: #0f1419;
            --card-bg: #1f2937;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            min-height: 100vh;
        }
        
        .status-not-started { color: #dc2626; }
        .status-in-progress { color: #f59e0b; }
        .status-completed { color: #10b981; }
        
        .bg-status-not-started { background-color: #dc2626; }
        .bg-status-in-progress { background-color: #f59e0b; }
        .bg-status-completed { background-color: #10b981; }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .house-box {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            font-size: 18px;
            color: white;
        }
        
        .house-box:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .house-box {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
        }

        /* ===== Ø²Ø± AL Ø§Ù„Ø°Ù‡Ø¨ÙŠ ===== */
        .al-logo-btn {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: var(--primary-gold);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1100;
            font-weight: 900;
            font-size: 15px;
            color: #111;
            box-shadow: 0 4px 14px rgba(201,169,97,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            letter-spacing: 1px;
        }
        .al-logo-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(201,169,97,0.7);
        }

        /* ===== Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ===== */
        .back-nav-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 48px;
            height: 48px;
            background: rgba(31,41,55,0.92);
            border: 2px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1100;
            font-size: 22px;
            color: white;
            transition: all 0.2s;
        }
        .back-nav-btn:hover {
            background: rgba(201,169,97,0.2);
            border-color: var(--primary-gold);
        }

        /* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ===== */
        .sidebar-panel {
            position: fixed;
            top: 0;
            right: -90px;
            width: 72px;
            height: 100vh;
            background: linear-gradient(180deg, #1a3a52 0%, #0f1419 100%);
            z-index: 1200;
            transition: right 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        .sidebar-panel.open {
            right: 0;
        }
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 1199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .sidebar-header-section {
            padding: 14px 0 10px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        .sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            padding: 12px 4px;
            color: #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            position: relative;
        }
        .sidebar-item:hover {
            background: rgba(201,169,97,0.15);
            color: var(--primary-gold);
        }
        .sidebar-item .s-icon {
            font-size: 22px;
            line-height: 1;
        }
        .sidebar-item .s-label {
            font-size: 9px;
            text-align: center;
            line-height: 1.2;
            max-width: 64px;
            word-break: break-word;
            color: #9ca3af;
        }
        .sidebar-item:hover .s-label {
            color: var(--primary-gold);
        }
        .sidebar-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 8px;
            min-width: 16px;
            text-align: center;
        }

        /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù†Ø¸ÙŠÙ ===== */
        .clean-header {
            height: 80px;
            position: sticky;
            top: 0;
            z-index: 500;
        }

        @media print {
            .al-logo-btn, .back-nav-btn, .sidebar-panel, .sidebar-overlay, .no-print {
                display: none !important;
            }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute;
                left: 0; top: 0;
                width: 100%;
            }
        }

        /* ===== Ø·Ø¨Ø§Ø¹Ø© A4 ===== */
        @media print {
            @page {
                size: A4;
                margin: 20mm;
            }
            .print-area {
                font-family: 'Cairo', sans-serif;
                color: #000 !important;
                background: white !important;
            }
            .print-area * {
                color: #000 !important;
                background: transparent !important;
                border-color: #ccc !important;
            }
        }

        /* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ù€ PWA ===== */

        /* Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø³ÙŠØ§Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Safe area Ù„Ù„Ù€ iPhone X ÙˆÙ…Ø§ ÙÙˆÙ‚ */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…Ø³ */
        button {
            touch-action: manipulation;
            cursor: pointer;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 640px) {
            .sidebar-panel {
                width: 80px;
            }
            .al-logo-btn {
                width: 42px;
                height: 42px;
                font-size: 13px;
                top: calc(env(safe-area-inset-top) + 10px);
                right: 12px;
            }
            .back-nav-btn {
                width: 42px;
                height: 42px;
                font-size: 20px;
                top: calc(env(safe-area-inset-top) + 10px);
                left: 12px;
            }
            .house-box {
                width: 44px;
                height: 44px;
                font-size: 13px;
            }
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 640px) {
            .modal-inner {
                max-height: 95vh !important;
                border-radius: 16px 16px 0 0 !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* Ø´Ø§Ø´Ø© ØªØ«Ø¨ÙŠØª PWA */
        #pwa-install-banner {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom) + 16px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1a3a52, #0f1419);
            border: 1px solid rgba(201,169,97,0.4);
            border-radius: 16px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: calc(100vw - 32px);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to   { transform: translateX(-50%) translateY(0);     opacity: 1; }
        }
        #pwa-install-banner .pwa-icon {
            width: 44px; height: 44px;
            background: var(--primary-gold);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 14px; color: #111;
            flex-shrink: 0;
        }
        #pwa-install-banner .pwa-text { flex: 1; }
        #pwa-install-banner .pwa-title {
            color: var(--primary-gold);
            font-weight: 700; font-size: 14px;
        }
        #pwa-install-banner .pwa-sub {
            color: #9ca3af; font-size: 11px; margin-top: 2px;
        }
        #pwa-install-banner .pwa-btn {
            background: var(--primary-gold);
            color: #111; font-weight: 700;
            border: none; border-radius: 10px;
            padding: 8px 16px; font-size: 13px;
            cursor: pointer; flex-shrink: 0;
            font-family: 'Cairo', sans-serif;
        }
        #pwa-install-banner .pwa-close {
            color: #6b7280; background: none; border: none;
            font-size: 20px; cursor: pointer; padding: 0 4px;
            line-height: 1; flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆÙ†Ø§Øª ====================
        const ZONES_DATA = {
            1: {
                id: 1,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„",
                color: "#2563eb",
                active: true,
                totalHouses: 210,
                blocks: [
                    { id: 1, number: 1, houses: 22, types: [{ type: "VY", from: 1, to: 22 }] },
                    { id: 2, number: 2, houses: 20, types: [{ type: "VY", houses: [1, 10, 11, 20] }, { type: "VK", houses: [2, 3, 4, 5, 6, 7, 8, 9, 12, 13, 14, 15, 16, 17, 18, 19] }] },
                    { id: 3, number: 3, houses: 20, types: [{ type: "VK", from: 1, to: 20 }] },
                    { id: 4, number: 4, houses: 18, types: [{ type: "VY", houses: [1, 9, 10, 18] }, { type: "VK", houses: [2, 3, 4, 5, 6, 7, 8, 11, 12, 13, 14, 15, 16, 17] }] },
                    { id: 5, number: 5, houses: 28, types: [{ type: "VK", from: 1, to: 28 }] },
                    { id: 6, number: 6, houses: 28, types: [{ type: "VK", from: 1, to: 28 }] },
                    { id: 7, number: 7, houses: 28, types: [{ type: "VK", houses: [1, 14, 15, 24, 28] }, { type: "VR", houses: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 16, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27] }] },
                    { id: 8, number: 8, houses: 24, types: [{ type: "VK", houses: [1, 7] }, { type: "VY", houses: [2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24] }] },
                    { id: 9, number: 9, houses: 14, types: [{ type: "VK", houses: [1, 2] }, { type: "VY", from: 3, to: 14 }] },
                    { id: 10, number: 10, houses: 8, types: [{ type: "VY", from: 1, to: 8 }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            },
            2: {
                id: 2,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ",
                color: "#16a34a",
                active: true,
                totalHouses: 148,
                blocks: [
                    { id: 1, number: 1, houses: 12, types: [{ type: "VY", from: 1, to: 12 }] },
                    { id: 2, number: 2, houses: 18, types: [{ type: "VY", from: 1, to: 18 }] },
                    { id: 3, number: 3, houses: 19, types: [{ type: "VY", from: 1, to: 19 }] },
                    { id: 4, number: 4, houses: 22, types: [{ type: "VY", from: 1, to: 22 }] },
                    { id: 5, number: 5, houses: 16, types: [{ type: "VY", from: 1, to: 16 }] },
                    { id: 6, number: 6, houses: 12, types: [{ type: "VY", from: 1, to: 12 }] },
                    { id: 7, number: 7, houses: 20, types: [{ type: "VY", from: 1, to: 20 }] },
                    { id: 8, number: 8, houses: 15, types: [{ type: "VY", from: 1, to: 15 }] },
                    { id: 9, number: 9, houses: 7, types: [{ type: "VY", from: 1, to: 7 }] },
                    { id: 10, number: 10, houses: 7, types: [{ type: "VY", from: 1, to: 4 }, { type: "VF", from: 5, to: 7 }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            },
            5: {
                id: 5,
                name: "Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³",
                color: "#dc2626",
                active: true,
                totalHouses: 289,
                blocks: [
                    { id: 1, number: 1, houses: 21, types: [{ type: "VK", houses: [1, 2, 3, 20, 21] }, { type: "VT", houses: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19] }] },
                    { id: 2, number: 2, houses: 22, types: [{ type: "VK", from: 1, to: 11 }, { type: "VT", from: 12, to: 22 }] },
                    { id: 3, number: 3, houses: 28, types: [{ type: "VT", from: 1, to: 28 }] },
                    { id: 4, number: 4, houses: 22, types: [{ type: "VT", from: 1, to: 22 }] },
                    { id: 5, number: 5, houses: 26, types: [{ type: "VT", from: 1, to: 26 }] },
                    { id: 6, number: 6, houses: 26, types: [{ type: "VT", from: 1, to: 26 }] },
                    { id: 7, number: 7, houses: 18, types: [{ type: "VK", from: 1, to: 8 }, { type: "VT", from: 9, to: 18 }] },
                    { id: 8, number: 8, houses: 24, types: [{ type: "VK", houses: [1, 2, 23, 24] }, { type: "VT", houses: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] }] },
                    { id: 9, number: 9, houses: 22, types: [{ type: "VT", from: 1, to: 22 }] },
                    { id: 10, number: 10, houses: 20, types: [{ type: "VT", from: 1, to: 20 }] },
                    { id: 11, number: 11, houses: 21, types: [{ type: "VK", from: 1, to: 3 }, { type: "VT", from: 4, to: 21 }] },
                    { id: 12, number: 12, houses: 15, types: [{ type: "VK", houses: [1, 2, 3, 14, 15] }, { type: "VT", houses: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13] }] },
                    { id: 13, number: 13, houses: 24, types: [{ type: "VK", houses: [1, 2, 23, 24] }, { type: "VT", houses: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] }] }
                ],
                departments: {
                    civil: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©",
                        icon: "ğŸ—ï¸",
                        tasks: [
                            { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                            { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                            { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                        ]
                    },
                    electrical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©",
                        icon: "âš¡",
                        tasks: [
                            { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                            { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                            { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                            { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                            { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                        ]
                    },
                    mechanical: {
                        name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©",
                        icon: "ğŸ”§",
                        tasks: [
                            { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                            { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                            { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                            { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                            { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                            { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                            { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                            { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                            { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                        ]
                    }
                }
            }
        };

        // ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø²ÙˆÙ†Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ====================
        const DYNAMIC_ZONES_KEY = 'alfarah_dynamic_zones';
        const DEPARTMENTS_TEMPLATE = {
            civil: {
                name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", icon: "ğŸ—ï¸",
                tasks: [
                    { id: "raft", name: "ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØª (Raft Foundation)" },
                    { id: "ground_coplin", name: "ØµØ¨ Ø§Ù„ÙƒÙˆØ¨Ù„Ù†" },
                    { id: "ground_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "ground_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "ground_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "ground_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "first_under_lintel", name: "Ø¨Ù†Ø§Ø¡ ØªØ­Øª Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                    { id: "first_lintel", name: "ØµØ¨ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                    { id: "first_above_lintel", name: "Ø¨Ù†Ø§Ø¡ ÙÙˆÙ‚ Ø§Ù„Ù„Ù†ØªÙ„ - Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                    { id: "first_ceiling", name: "ØµØ¨ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                    { id: "curtain", name: "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ØªØ§Ø±Ø©" }
                ]
            },
            electrical: {
                name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", icon: "âš¡",
                tasks: [
                    { id: "pipes_foundation", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                    { id: "pipes_ground_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "pipes_second_ceiling", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                    { id: "pipes_ground_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "pipes_second_wall", name: "Ù…Ø¯ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨ ÙÙŠ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø«Ø§Ù†ÙŠ" },
                    { id: "boxes", name: "ÙˆØ²Ù† ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙˆÙƒØ³Ø§Øª" },
                    { id: "wiring", name: "Ø§Ù„ØªØ³Ù„ÙŠÙƒ" },
                    { id: "installations", name: "Ø§Ù„ØªØ±Ø§ÙƒÙŠØ¨" },
                    { id: "testing", name: "Ø§Ù„ÙØ­Øµ" }
                ]
            },
            mechanical: {
                name: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©", icon: "ğŸ”§",
                tasks: [
                    { id: "foundation_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ø§Ù„Ø­ØµÙŠØ±ÙŠ" },
                    { id: "ground_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠ" },
                    { id: "first_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ ÙÙŠ Ø³Ù‚Ù Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£ÙˆÙ„" },
                    { id: "distillation", name: "Ø£Ø¹Ù…Ø§Ù„ ØªÙ‚Ø·ÙŠØ±" },
                    { id: "hanging_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚" },
                    { id: "ppr", name: "Ø£Ø¹Ù…Ø§Ù„ PPR" },
                    { id: "testing_mech", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙØ­Øµ" },
                    { id: "garage_drainage", name: "Ø£Ø¹Ù…Ø§Ù„ Ø±Ø¨Ø· Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØ±Ø§Ø¬" },
                    { id: "finishing", name: "Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØªØ´Ø·ÙŠØ¨" }
                ]
            }
        };

        function loadDynamicZones() {
            try {
                const saved = localStorage.getItem(DYNAMIC_ZONES_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch(e) { return {}; }
        }

        function saveDynamicZones(zones) {
            localStorage.setItem(DYNAMIC_ZONES_KEY, JSON.stringify(zones));
            cloudSync.fbSet('alfarah/dynamicZones', zones).catch(e => console.warn('Firebase dyn zones error', e));
        }

        async function syncDynamicZonesFromCloud() {
            try {
                const data = await cloudSync.fbGet('alfarah/dynamicZones');
                if (data && typeof data === 'object') {
                    const local = loadDynamicZones();
                    const merged = { ...local, ...data };
                    localStorage.setItem(DYNAMIC_ZONES_KEY, JSON.stringify(merged));
                    return merged;
                }
            } catch(e) { console.warn('Firebase dyn zones sync error', e); }
            return loadDynamicZones();
        }

        function getAllZonesData() {
            const dynamic = loadDynamicZones();
            const dynamicConverted = {};
            Object.keys(dynamic).forEach(k => { dynamicConverted[Number(k)] = dynamic[k]; });
            return { ...ZONES_DATA, ...dynamicConverted };
        }

        // Helper function to get house type
        function getHouseType(zoneId, blockNumber, houseNumber) {
            const allZones = getAllZonesData();
            const zone = allZones[zoneId];
            if (!zone) return 'VY';
            
            const block = zone.blocks.find(b => b.number === blockNumber);
            if (!block || !block.types) return 'VY';
            
            for (const typeInfo of block.types) {
                if (typeInfo.from && typeInfo.to) {
                    if (houseNumber >= typeInfo.from && houseNumber <= typeInfo.to) {
                        return typeInfo.type;
                    }
                } else if (typeInfo.houses && typeInfo.houses.includes(houseNumber)) {
                    return typeInfo.type;
                }
            }
            
            return 'VY';
        }

        // ==================== Firebase Realtime Database Sync ====================
        // Firebase Config
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDNzqb_6GRzK6uFxo_Jz8knRYnEIJD9jJA",
            authDomain: "alfarah-9c40c.firebaseapp.com",
            databaseURL: "https://alfarah-9c40c-default-rtdb.firebaseio.com",
            projectId: "alfarah-9c40c",
            storageBucket: "alfarah-9c40c.firebasestorage.app",
            messagingSenderId: "131040315801",
            appId: "1:131040315801:web:fa20190fae22963964ab08",
            measurementId: "G-SDP3E76YNV"
        };

        const DB_URL = FIREBASE_CONFIG.databaseURL;

        class CloudSync {
            constructor() {
                this.lastSyncTime = 0;
                this.syncInProgress = false;
                this.listeners = {};
                console.log('ğŸ”¥ Firebase Realtime Database initialized');
            }

            // ---- Helper: REST API call to Firebase ----
            async fbGet(path) {
                const res = await fetch(`${DB_URL}/${path}.json`);
                if (!res.ok) throw new Error(`Firebase GET failed: ${res.status}`);
                return await res.json();
            }

            async fbSet(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase SET failed: ${res.status}`);
                return await res.json();
            }

            async fbPatch(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase PATCH failed: ${res.status}`);
                return await res.json();
            }

            async fbPush(path, data) {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error(`Firebase PUSH failed: ${res.status}`);
                return await res.json();
            }

            // ---- Main sync: fetch all data ----
            async syncData() {
                try {
                    console.log('ğŸ“¡ Fetching data from Firebase...');
                    const data = await this.fbGet('alfarah');
                    this.lastSyncTime = Date.now();
                    console.log('âœ… Firebase sync successful');
                    return data || {};
                } catch (error) {
                    console.error('âŒ Firebase syncData error:', error);
                    return null;
                }
            }

            // ---- Save zone data ----
            async saveZoneData(zoneId, zoneData) {
                try {
                    await this.fbSet(`alfarah/zone${zoneId}`, zoneData);
                    console.log(`âœ… Zone ${zoneId} saved to Firebase`);
                } catch (error) {
                    console.error(`âŒ Error saving zone ${zoneId}:`, error);
                }
            }

            // ---- Log activity ----
            async logActivity(activity) {
                try {
                    await this.fbPush('alfarah/activities', { ...activity, _ts: Date.now() });
                    console.log('âœ… Activity logged to Firebase');
                } catch (error) {
                    console.error('âŒ Error logging activity:', error);
                }
            }

            // ---- Log report ----
            async logReport(report) {
                try {
                    await this.fbPush('alfarah/reports', { ...report, _ts: Date.now() });
                    console.log('âœ… Report saved to Firebase');
                } catch (error) {
                    console.error('âŒ Error saving report:', error);
                }
            }

            // ---- Log approval request ----
            async logApprovalRequest(request) {
                try {
                    await this.fbPush('alfarah/approvalRequests', { ...request, _ts: Date.now() });
                    console.log('âœ… Approval request saved to Firebase');
                } catch (error) {
                    console.error('âŒ Error saving approval request:', error);
                }
            }

            // ---- Save users ----
            async saveUsers(users) {
                try {
                    console.log('ğŸ’¾ Saving users to Firebase...');
                    await this.fbSet('alfarah/users', users);
                    console.log('âœ… Users saved to Firebase');
                    alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Firebase!\n\nØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${users.length}\n\nÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø²`);
                } catch (error) {
                    console.error('âŒ Error saving users:', error);
                    alert('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Firebase');
                }
            }

            // ---- Upload full data (compatibility) ----
            async uploadFullData(data) {
                try {
                    await this.fbSet('alfarah', data);
                    this.lastSyncTime = Date.now();
                    console.log('âœ… Full data uploaded to Firebase');
                    return true;
                } catch (error) {
                    console.error('âŒ uploadFullData error:', error);
                    return false;
                }
            }

            // ---- Ø­Ø°Ù Ù…Ø³Ø§Ø± Ù…Ù† Firebase ----
            async fbDelete(path) {
                const res = await fetch(`${DB_URL}/${path}.json`, { method: 'DELETE' });
                if (!res.ok) throw new Error(`Firebase DELETE failed: ${res.status}`);
                return true;
            }

            // ---- Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ----
            async deleteAllData() {
                try {
                    // Ø­Ø°Ù Ù…Ù† Firebase Ø¨Ù€ DELETE
                    const paths = ['alfarah/zone1','alfarah/zone2','alfarah/zone5','alfarah/zone3','alfarah/zone4','alfarah/activities','alfarah/reports','alfarah/approvalRequests'];
                    for (const p of paths) {
                        try { await this.fbDelete(p); } catch(e) { console.warn('skip:', p); }
                    }

                    // Ù…Ø³Ø­ ÙƒÙ„ LocalStorage Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    const keysToDelete = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('zone') || key.startsWith('alfarah_') || key === 'approval_requests')) {
                            keysToDelete.push(key);
                        }
                    }
                    keysToDelete.forEach(k => localStorage.removeItem(k));

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† dataManager ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                    dataManager.data = {};
                    dataManager.activityLog = [];
                    dataManager.editTimes = {};
                    dataManager.reportHistory = [];

                    console.log('ğŸ—‘ï¸ Deleted keys:', keysToDelete);
                    return true;
                } catch (error) {
                    console.error('âŒ deleteAllData error:', error);
                    return false;
                }
            }

            // ---- Real-time listener for a zone ----
            startZoneListener(zoneId, callback) {
                // Use Server-Sent Events (Firebase REST streaming)
                const url = `${DB_URL}/alfarah/zone${zoneId}.json?accept=text/event-stream`;
                try {
                    const evtSource = new EventSource(url);
                    evtSource.addEventListener('put', (e) => {
                        try {
                            const parsed = JSON.parse(e.data);
                            if (parsed && parsed.data) {
                                console.log(`ğŸ”” Firebase: Zone ${zoneId} updated in real-time`);
                                callback(parsed.data);
                            }
                        } catch (err) {
                            console.error('SSE parse error:', err);
                        }
                    });
                    evtSource.onerror = (err) => {
                        console.warn(`âš ï¸ SSE zone${zoneId} error, will retry`, err);
                    };
                    this.listeners[`zone${zoneId}`] = evtSource;
                    console.log(`ğŸ‘‚ Listening for real-time updates on Zone ${zoneId}`);
                } catch (e) {
                    console.warn('EventSource not supported, using polling');
                }
            }

            stopZoneListener(zoneId) {
                const key = `zone${zoneId}`;
                if (this.listeners[key]) {
                    this.listeners[key].close();
                    delete this.listeners[key];
                }
            }

            // ---- Export CSV ----
            async exportData() {
                try {
                    const data = await this.syncData();
                    if (data) {
                        let csv = '\ufeffØ§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø²ÙˆÙ†,Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…,Ø§Ù„Ù‚Ø³Ù…,Ø§Ù„Ø¹Ù…Ù„,Ø§Ù„Ø¨Ù„ÙˆÙƒ,Ø§Ù„Ø¨ÙŠØª,Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©,Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n';
                        
                        if (data.activities) {
                            // Firebase returns object with keys, convert to array
                            const acts = typeof data.activities === 'object' && !Array.isArray(data.activities)
                                ? Object.values(data.activities)
                                : data.activities;
                            acts.forEach(activity => {
                                csv += `${activity.timestamp},${activity.zoneName},${activity.username},${activity.department},${activity.task},${activity.block},${activity.house},${activity.oldStatus},${activity.newStatus}\n`;
                            });
                        }

                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `ALFARAH_Data_${new Date().toISOString().split('T')[0]}.csv`;
                        link.click();
                        return true;
                    }
                } catch (error) {
                    console.error('Error exporting data:', error);
                }
                return false;
            }
        }

        const cloudSync = new CloudSync();

        // ==================== Data Manager ====================
        class DataManager {
            constructor(zoneId = 2) {
                this.zoneId = zoneId;
                this.data = {};
                this.activityLog = [];
                this.editTimes = {};
                this.reportDraft = null;
                this.reportHistory = [];
                this.loadData();
            }

            async setZone(zoneId) {
                this.zoneId = zoneId;
                await this.loadData();
            }

            getZoneData() {
                return getAllZonesData()[this.zoneId];
            }

            async loadData() {
                // Load from localStorage first
                const zoneData = localStorage.getItem(`zone${this.zoneId}_data_v2`);
                const activityLog = localStorage.getItem(`zone${this.zoneId}_activity_log_v2`);
                const editTimes = localStorage.getItem(`zone${this.zoneId}_edit_times`);
                const reportDraft = localStorage.getItem(`zone${this.zoneId}_daily_report_draft`);
                const reportHistory = localStorage.getItem(`zone${this.zoneId}_report_history`);

                this.data = zoneData ? JSON.parse(zoneData) : {};
                this.activityLog = activityLog ? JSON.parse(activityLog) : [];
                this.editTimes = editTimes ? JSON.parse(editTimes) : {};
                this.reportDraft = reportDraft ? JSON.parse(reportDraft) : null;
                this.reportHistory = reportHistory ? JSON.parse(reportHistory) : [];
                
                // Then sync from cloud
                await this.syncFromCloud();
            }

            async syncFromCloud() {
                try {
                    const cloudData = await cloudSync.syncData();
                    if (!cloudData) return;

                    const zoneKey = `zone${this.zoneId}`;
                    if (cloudData[zoneKey]) {
                        const cz = cloudData[zoneKey];
                        if (cz.data) this.data = { ...this.data, ...cz.data };
                        if (cz.activityLog) {
                            const arr = Array.isArray(cz.activityLog) ? cz.activityLog : Object.values(cz.activityLog);
                            const ts = new Set(this.activityLog.map(a => a.timestamp));
                            const nw = arr.filter(a => !ts.has(a.timestamp));
                            if (nw.length > 0) this.activityLog = [...nw, ...this.activityLog];
                        }
                        if (cz.editTimes) this.editTimes = { ...this.editTimes, ...cz.editTimes };
                        localStorage.setItem(`zone${this.zoneId}_data_v2`, JSON.stringify(this.data));
                        localStorage.setItem(`zone${this.zoneId}_activity_log_v2`, JSON.stringify(this.activityLog));
                        localStorage.setItem(`zone${this.zoneId}_edit_times`, JSON.stringify(this.editTimes));
                        console.log(`âœ… Synced zone ${this.zoneId} from Firebase`);
                    }
                    if (cloudData.reports) {
                        const arr = Array.isArray(cloudData.reports) ? cloudData.reports : Object.values(cloudData.reports);
                        const zr = arr.filter(r => r.zoneId === this.zoneId);
                        if (zr.length > 0) {
                            const ed = new Set(this.reportHistory.map(r => r.submittedAt));
                            const nr = zr.filter(r => !ed.has(r.submittedAt));
                            if (nr.length > 0) {
                                this.reportHistory = [...nr, ...this.reportHistory];
                                localStorage.setItem(`zone${this.zoneId}_report_history`, JSON.stringify(this.reportHistory));
                            }
                        }
                    }
                    if (cloudData.approvalRequests) {
                        const arr = Array.isArray(cloudData.approvalRequests) ? cloudData.approvalRequests : Object.values(cloudData.approvalRequests);
                        const local = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                        const ids = new Set(local.map(r => r.id));
                        const nw = arr.filter(r => !ids.has(r.id));
                        if (nw.length > 0) localStorage.setItem('approval_requests', JSON.stringify([...nw, ...local]));
                    }
                    if (cloudData.users && Array.isArray(cloudData.users) && cloudData.users.length > 0) {
                        const lu = JSON.parse(localStorage.getItem('alfarah_users') || '[]');
                        if (cloudData.users.length >= lu.length) {
                            localStorage.setItem('alfarah_users', JSON.stringify(cloudData.users));
                            console.log(`âœ… Synced ${cloudData.users.length} users from Firebase`);
                        }
                    }
                } catch (error) {
                    console.error('Error syncing from Firebase:', error);
                }
            }

            saveData() {
                localStorage.setItem(`zone${this.zoneId}_data_v2`, JSON.stringify(this.data));
                localStorage.setItem(`zone${this.zoneId}_activity_log_v2`, JSON.stringify(this.activityLog));
                localStorage.setItem(`zone${this.zoneId}_edit_times`, JSON.stringify(this.editTimes));
                return cloudSync.saveZoneData(this.zoneId, {
                    data: this.data,
                    activityLog: this.activityLog,
                    editTimes: this.editTimes
                });
            }

            getStatus(blockId, houseId, department, taskId) {
                const key = `${blockId}-${houseId}-${department}-${taskId}`;
                return this.data[key] || 'not-started';
            }

            canEditDirectly(blockId, houseId, department, taskId) {
                return true;
            }

            updateStatus(blockId, houseId, department, taskId, newStatus, username, userRole) {
                const key = `${blockId}-${houseId}-${department}-${taskId}`;
                const oldStatus = this.data[key] || 'not-started';
                if (oldStatus === newStatus) return;

                const rank = { 'not-started': 0, 'in-progress': 1, 'completed': 2 };
                const isRegression = rank[newStatus] < rank[oldStatus];

                if (isRegression && userRole === 'engineer') {
                    const request = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        timestampDisplay: new Date().toLocaleString('en-GB'),
                        username,
                        zoneName: this.getZoneData().name,
                        zoneId: this.zoneId,
                        block: blockId,
                        house: houseId,
                        department,
                        departmentName: this.getDepartmentName(department),
                        task: taskId,
                        taskName: this.getTaskName(department, taskId),
                        oldStatus,
                        newStatus,
                        oldStatusText: this.getStatusText(oldStatus),
                        newStatusText: this.getStatusText(newStatus),
                        reason: 'ØªØ±Ø§Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ­ØªØ§Ø¬ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±',
                        status: 'pending'
                    };
                    const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                    requests.unshift(request);
                    localStorage.setItem('approval_requests', JSON.stringify(requests));
                    cloudSync.logApprovalRequest(request);
                    return 'approval-needed';
                }

                this.data[key] = newStatus;
                this.editTimes[key] = new Date().getTime();
                
                const activity = {
                    timestamp: new Date().toISOString(),
                    timestampDisplay: new Date().toLocaleString('en-GB'),
                    username,
                    zoneName: this.getZoneData().name,
                    block: blockId,
                    house: houseId,
                    department: this.getDepartmentName(department),
                    task: this.getTaskName(department, taskId),
                    oldStatus: oldStatus,
                    newStatus: newStatus,
                    oldStatusText: this.getStatusText(oldStatus),
                    newStatusText: this.getStatusText(newStatus)
                };
                
                this.activityLog.unshift(activity);
                this.saveData();
                
                console.log('âœ… Activity saved:', activity);
                console.log('ğŸ“Š Total activities in log:', this.activityLog.length);
                
                // Send to Cloud
                cloudSync.logActivity(activity);
                
                return 'success';
            }
            
            approveRequest(requestId) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                const request = requests.find(r => r.id === requestId);
                
                if (!request) return false;
                
                // Apply the change
                const key = `${request.block}-${request.house}-${request.department}-${request.task}`;
                this.data[key] = request.newStatus;
                this.editTimes[key] = new Date().getTime();
                
                // Log activity
                const activity = {
                    timestamp: new Date().toISOString(),
                    timestampDisplay: new Date().toLocaleString('en-GB'),
                    username: request.username,
                    zoneName: request.zoneName,
                    block: request.block,
                    house: request.house,
                    department: request.departmentName,
                    task: request.taskName,
                    oldStatus: request.oldStatus,
                    newStatus: request.newStatus,
                    oldStatusText: request.oldStatusText,
                    newStatusText: request.newStatusText
                };
                
                this.activityLog.unshift(activity);
                this.saveData();
                
                // Update request status
                request.status = 'approved';
                request.approvedAt = new Date().toISOString();
                localStorage.setItem('approval_requests', JSON.stringify(requests));
                
                cloudSync.logActivity(activity);
                
                return true;
            }
            
            rejectRequest(requestId, reason) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                const request = requests.find(r => r.id === requestId);
                
                if (!request) return false;
                
                request.status = 'rejected';
                request.rejectedAt = new Date().toISOString();
                request.rejectionReason = reason;
                
                localStorage.setItem('approval_requests', JSON.stringify(requests));
                
                return true;
            }
            
            getPendingRequests() {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                return requests.filter(r => r.status === 'pending');
            }
            
            getMyRequests(username) {
                const requests = JSON.parse(localStorage.getItem('approval_requests') || '[]');
                return requests.filter(r => r.username === username);
            }

            getDepartmentName(deptKey) {
                const zoneData = this.getZoneData();
                return zoneData.departments[deptKey]?.name || deptKey;
            }

            getTaskName(department, taskId) {
                const zoneData = this.getZoneData();
                const dept = zoneData.departments[department];
                
                const task = dept.tasks.find(t => t.id === taskId);
                return task ? task.name : taskId;
            }

            getStatusText(status) {
                const statuses = {
                    'not-started': 'Ù„Ù… ÙŠØ¨Ø¯Ø£',
                    'in-progress': 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²',
                    'completed': 'Ù…Ù†Ø¬Ø²'
                };
                return statuses[status] || status;
            }

            saveDraft(data) {
                this.reportDraft = {
                    ...data,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(`zone${this.zoneId}_daily_report_draft`, JSON.stringify(this.reportDraft));
            }

            submitReport(reportData) {
                const report = {
                    ...reportData,
                    zoneName: this.getZoneData().name,
                    zoneId: this.zoneId,
                    date: new Date().toLocaleDateString('ar-EG'),
                    time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                    submittedAt: new Date().toISOString()
                };

                this.reportHistory.unshift(report);
                localStorage.setItem(`zone${this.zoneId}_report_history`, JSON.stringify(this.reportHistory));
                
                this.reportDraft = null;
                localStorage.removeItem(`zone${this.zoneId}_daily_report_draft`);
                
                // Save to cloud
                cloudSync.logReport(report);
                
                return report;
            }

            isReportSubmittedToday() {
                if (this.reportHistory.length === 0) return false;
                
                const lastReport = this.reportHistory[0];
                const lastReportDate = new Date(lastReport.submittedAt);
                const today = new Date();
                
                return lastReportDate.toDateString() === today.toDateString();
            }

            getTodayChanges() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowTimestamp = tomorrow.getTime();
                
                const zoneName = this.getZoneData().name;
                
                const filtered = this.activityLog.filter(activity => {
                    const activityTime = new Date(activity.timestamp).getTime();
                    return activityTime >= todayTimestamp && 
                           activityTime < tomorrowTimestamp && 
                           activity.zoneName === zoneName;
                });
                
                console.log('ğŸ“Š getTodayChanges called');
                console.log('   Zone:', zoneName);
                console.log('   Total activities:', this.activityLog.length);
                console.log('   Today\'s activities:', filtered.length);
                
                return filtered;
            }
        }

        const dataManager = new DataManager(2);

        // ==================== User Management ====================
        class UserManager {
            constructor() {
                this.users = [];
                this.loadUsers();
            }

            async loadUsers() {
                // Load from localStorage first
                const saved = localStorage.getItem('alfarah_users_v2');
                if (saved) {
                    this.users = JSON.parse(saved);
                } else {
                    this.users = [
                        {
                            id: 1,
                            username: 'ali',
                            password: '112123',
                            name: 'Ø¹Ù„ÙŠ',
                            role: 'admin',
                            hidden: true
                        }
                    ];
                }
                
                // Sync from cloud
                await this.syncFromCloud();
            }
            
            async syncFromCloud() {
                try {
                    console.log('ğŸ”„ Syncing users from cloud...');
                    const cloudData = await cloudSync.syncData();
                    console.log('â˜ï¸ Cloud data received:', cloudData ? 'Yes' : 'No');
                    
                    if (cloudData && cloudData.users) {
                        console.log('ğŸ‘¥ Cloud users count:', cloudData.users.length);
                        console.log('ğŸ‘¥ Cloud users:', cloudData.users.map(u => u.username));
                        
                        // Replace all users with cloud users (except admin)
                        const admin = this.users.find(u => u.username === 'ali');
                        const cloudUsers = cloudData.users.filter(u => u.username !== 'ali');
                        
                        this.users = admin ? [admin, ...cloudUsers] : cloudUsers;
                        
                        localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                        console.log('âœ… Users synced from cloud:', this.users.length);
                        console.log('ğŸ‘¥ Available usernames:', this.users.map(u => u.username));
                    } else {
                        console.log('âš ï¸ No users in cloud, using local only');
                    }
                } catch (error) {
                    console.error('âŒ Error syncing users from cloud:', error);
                }
            }

            saveUsers() {
                localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                console.log('ğŸ’¾ Saving users to cloud...');
                console.log('ğŸ‘¥ Users to save:', this.users.length);
                // Also save to cloud
                cloudSync.saveUsers(this.users);
            }
            
            // Export users as shareable code
            exportUsersCode() {
                const data = btoa(unescape(encodeURIComponent(JSON.stringify(this.users))));
                return data;
            }
            
            // Import users from code
            importUsersCode(code) {
                try {
                    const users = JSON.parse(decodeURIComponent(escape(atob(code))));
                    // Keep admin, merge others
                    const admin = this.users.find(u => u.username === 'ali');
                    const importedUsers = users.filter(u => u.username !== 'ali');
                    
                    this.users = admin ? [admin, ...importedUsers] : importedUsers;
                    localStorage.setItem('alfarah_users_v2', JSON.stringify(this.users));
                    
                    return { success: true, count: importedUsers.length };
                } catch (error) {
                    console.error('Import error:', error);
                    return { success: false, message: 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­' };
                }
            }

            authenticate(username, password) {
                return this.users.find(u => u.username === username && u.password === password);
            }

            addUser(userData) {
                const newUser = {
                    id: Date.now(),
                    ...userData
                };
                this.users.push(newUser);
                this.saveUsers();
                return newUser;
            }

            updatePassword(userId, newPassword) {
                const user = this.users.find(u => u.id === userId);
                if (user) {
                    user.password = newPassword;
                    this.saveUsers();
                    return true;
                }
                return false;
            }

            deleteUser(userId) {
                this.users = this.users.filter(u => u.id !== userId);
                this.saveUsers();
            }

            getVisibleUsers() {
                return this.users.filter(u => !u.hidden);
            }
        }

        const userManager = new UserManager();
        // UserManager will load users asynchronously in LoginScreen

        // ==================== Login Component ====================
        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                // Ù…Ø²Ø§Ù…Ù†Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                userManager.loadUsers().catch(e => console.warn('sync:', e));
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                const user = userManager.authenticate(username, password);
                if (user) {
                    onLogin(user);
                } else {
                    setError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
                        <div className="text-center mb-10">
                            <div style={{
                                width: 72, height: 72,
                                background: 'var(--primary-gold)',
                                borderRadius: 16,
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                margin: '0 auto 16px',
                                fontWeight: 900, fontSize: 22, color: '#111', letterSpacing: 1
                            }}>AL</div>
                            <h1 className="text-3xl font-bold mb-1" style={{ color: 'var(--primary-gold)' }}>ALFARAH</h1>
                            <p className="text-gray-400 text-sm">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-gray-300 mb-2 text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    required
                                    autoFocus
                                />
                            </div>

                            <div>
                                <label className="block text-gray-300 mb-2 text-sm">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    required
                                />
                            </div>

                            {error && (
                                <div className="bg-red-500 bg-opacity-20 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full py-3 rounded-lg font-bold text-gray-900 hover:opacity-90 transition"
                                style={{ backgroundColor: 'var(--primary-gold)' }}
                            >
                                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function ZoneSelection({ onSelectZone, availableZones, currentUser, onLogout, onShowReport, onShowUserManagement, onShowApprovals, onShowZoneManagement }) {
            const dynamicZones = loadDynamicZones();
            const allZones = [
                { id: 1, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„', color: '#2563eb', active: true, houses: 210, blocks: 10 },
                { id: 2, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', color: '#16a34a', active: true, houses: 148, blocks: 10 },
                { id: 3, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù„Ø«', color: '#9333ea', active: !!(dynamicZones[3] && dynamicZones[3].blocks && dynamicZones[3].blocks.length > 0), houses: dynamicZones[3] ? dynamicZones[3].totalHouses || 0 : 0, blocks: dynamicZones[3] ? (dynamicZones[3].blocks || []).length : 0 },
                { id: 4, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø¹', color: '#ea580c', active: !!(dynamicZones[4] && dynamicZones[4].blocks && dynamicZones[4].blocks.length > 0), houses: dynamicZones[4] ? dynamicZones[4].totalHouses || 0 : 0, blocks: dynamicZones[4] ? (dynamicZones[4].blocks || []).length : 0 },
                { id: 5, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³', color: '#dc2626', active: true, houses: 289, blocks: 13 }
            ];
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const pendingCount = dataManager.getPendingRequests().length;
            const zones = availableZones
                ? allZones.filter(z => availableZones.includes(z.id))
                : allZones;

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{ paddingTop: 80 }}>
                    <button className="al-logo-btn no-print" onClick={() => setSidebarOpen(true)}>AL</button>
                    <div className={`sidebar-overlay ${sidebarOpen ? 'active' : ''}`} onClick={() => setSidebarOpen(false)} />
                    <div className={`sidebar-panel ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header-section">
                            <div style={{ color: 'var(--primary-gold)', fontWeight: 900, fontSize: 13, letterSpacing: 1 }}>AL</div>
                        </div>
                        <div className="sidebar-item" onClick={() => setSidebarOpen(false)}>
                            <span className="s-icon">ğŸ—ºï¸</span>
                            <span className="s-label">Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                        </div>
                        {onShowReport && (
                            <div className="sidebar-item" onClick={() => { onShowReport(); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ“Š</span>
                                <span className="s-label">ØªÙ‚Ø§Ø±ÙŠØ±</span>
                            </div>
                        )}
                        {onShowApprovals && (currentUser.role === 'manager' || currentUser.role === 'engineer') && (
                            <div className="sidebar-item" onClick={() => { onShowApprovals(); setSidebarOpen(false); }}>
                                <span className="s-icon">{currentUser.role === 'manager' ? 'âœ‹' : 'ğŸ“'}</span>
                                <span className="s-label">{currentUser.role === 'manager' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Ø·Ù„Ø¨Ø§ØªÙŠ'}</span>
                                {currentUser.role === 'manager' && pendingCount > 0 && <span className="sidebar-badge">{pendingCount}</span>}
                            </div>
                        )}
                        {onShowUserManagement && (currentUser.role === 'admin' || currentUser.role === 'manager') && (
                            <div className="sidebar-item" onClick={() => { onShowUserManagement(); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ‘¥</span>
                                <span className="s-label">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            </div>
                        )}
                        {onShowZoneManagement && currentUser.role === 'manager' && (
                            <div className="sidebar-item" onClick={() => { onShowZoneManagement(); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ—ï¸</span>
                                <span className="s-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                            </div>
                        )}
                        <div style={{ marginTop: 'auto' }}>
                            <div className="sidebar-item" style={{ color: '#ef4444' }} onClick={onLogout}>
                                <span className="s-icon">ğŸšª</span>
                                <span className="s-label" style={{ color: '#ef4444' }}>Ø®Ø±ÙˆØ¬</span>
                            </div>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl">
                        <div className="text-center mb-12">
                            <h1 className="text-5xl font-bold mb-3" style={{ color: 'var(--primary-gold)' }}>ALFARAH</h1>
                            <div className="w-24 h-1 mx-auto mb-4" style={{ backgroundColor: 'var(--primary-gold)' }}></div>
                            <p className="text-gray-300 text-2xl font-light">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {zones.map(zone => (
                                <button
                                    key={zone.id}
                                    onClick={() => zone.active && onSelectZone(zone.id)}
                                    disabled={!zone.active}
                                    className={`group relative overflow-hidden rounded-xl transition-all duration-300 ${
                                        zone.active 
                                            ? 'hover:shadow-2xl hover:-translate-y-1 cursor-pointer' 
                                            : 'cursor-not-allowed'
                                    }`}
                                    style={{ 
                                        backgroundColor: '#1f2937',
                                        border: zone.active ? `2px solid ${zone.color}40` : '2px solid #374151'
                                    }}
                                >
                                    <div 
                                        className="absolute top-0 left-0 right-0 h-1"
                                        style={{ backgroundColor: zone.active ? zone.color : '#6b7280' }}
                                    />
                                    
                                    <div className="p-8">
                                        <div className="flex items-center justify-between mb-6">
                                            <div 
                                                className="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl"
                                                style={{ 
                                                    backgroundColor: zone.active ? `${zone.color}30` : '#37415130',
                                                    border: `2px solid ${zone.active ? zone.color : '#6b7280'}`
                                                }}
                                            >
                                                {zone.id}
                                            </div>
                                            
                                            {zone.active ? (
                                                <div className="px-3 py-1 rounded-full text-xs font-semibold" style={{ 
                                                    backgroundColor: `${zone.color}20`,
                                                    color: zone.color 
                                                }}>
                                                    Ù†Ø´Ø·
                                                </div>
                                            ) : (
                                                <div className="px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-400">
                                                    Ù‚Ø±ÙŠØ¨Ø§Ù‹
                                                </div>
                                            )}
                                        </div>

                                        <h3 className="text-2xl font-bold mb-6" style={{ 
                                            color: zone.active ? '#fff' : '#9ca3af'
                                        }}>
                                            {zone.name}
                                        </h3>

                                        {zone.active && (
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between text-gray-300">
                                                    <span className="text-sm flex items-center gap-2">
                                                        <span className="text-lg">ğŸ—ï¸</span>
                                                        Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª
                                                    </span>
                                                    <span className="font-bold text-white">{zone.blocks}</span>
                                                </div>
                                                <div className="flex items-center justify-between text-gray-300">
                                                    <span className="text-sm flex items-center gap-2">
                                                        <span className="text-lg">ğŸ </span>
                                                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±
                                                    </span>
                                                    <span className="font-bold text-white">{zone.houses}</span>
                                                </div>
                                            </div>
                                        )}

                                        {!zone.active && (
                                            <p className="text-gray-500 text-sm text-center py-4">
                                                Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø²ÙˆÙ† Ù‚Ø±ÙŠØ¨Ø§Ù‹
                                            </p>
                                        )}
                                    </div>

                                    {zone.active && (
                                        <div 
                                            className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                            style={{ 
                                                background: `linear-gradient(135deg, ${zone.color}10 0%, transparent 100%)`
                                            }}
                                        />
                                    )}
                                </button>
                            ))}
                        </div>

                        <div className="mt-12 text-center">
                            <p className="text-gray-400 text-sm">
                                Ø§Ø®ØªØ± Ø§Ù„Ø²ÙˆÙ† Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Main App ====================
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [currentZone, setCurrentZone] = useState(null);
            const [currentView, setCurrentView] = useState('departments');
            const [selectedDepartment, setSelectedDepartment] = useState(null);
            const [selectedTask, setSelectedTask] = useState(null);
            const [selectedBlock, setSelectedBlock] = useState(null);
            const [showSearch, setShowSearch] = useState(false);
            const [showReport, setShowReport] = useState(false);
            const [showUserManagement, setShowUserManagement] = useState(false);
            const [showApprovals, setShowApprovals] = useState(false);
            const [showZoneManagement, setShowZoneManagement] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                if (currentZone) {
                    setIsSyncing(true);
                    dataManager.setZone(currentZone).then(() => {
                        setTimeout(() => {
                            setIsSyncing(false);
                            setCurrentView('departments');
                        }, 500);
                    });
                }
            }, [currentZone]);

            useEffect(() => {
                if (!currentZone) return;
                const syncInterval = setInterval(async () => {
                    try { await dataManager.syncFromCloud(); } catch (e) {}
                }, 30000);
                return () => clearInterval(syncInterval);
            }, [currentZone]);

            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === 15 && now.getMinutes() === 0) {
                        if (!dataManager.isReportSubmittedToday()) {
                            const todayChanges = dataManager.getTodayChanges();
                            dataManager.submitReport({
                                workers: 0, technicians: 0,
                                totalChanges: todayChanges.length,
                                preparedBy: 'Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ', notes: 'ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ'
                            });
                        }
                    }
                }, 60000);
                return () => clearInterval(interval);
            }, [currentZone]);

            if (!currentUser) return <LoginScreen onLogin={setCurrentUser} />;

            if (!currentZone) {
                let availableZones = null;
                if (currentUser.role === 'engineer') {
                    if (currentUser.assignedZones && currentUser.assignedZones.length > 0) {
                        availableZones = currentUser.assignedZones;
                    } else if (currentUser.assignedZone) {
                        availableZones = [currentUser.assignedZone];
                    }
                }
                return (
                    <>
                        <ZoneSelection
                            onSelectZone={setCurrentZone}
                            availableZones={availableZones}
                            currentUser={currentUser}
                            onLogout={() => setCurrentUser(null)}
                            onShowReport={() => setShowReport(true)}
                            onShowUserManagement={() => setShowUserManagement(true)}
                            onShowApprovals={() => setShowApprovals(true)}
                            onShowZoneManagement={() => setShowZoneManagement(true)}
                        />
                        {showReport && <ReportModal currentUser={currentUser} onClose={() => setShowReport(false)} />}
                        {showUserManagement && <UserManagementModal currentUser={currentUser} onClose={() => setShowUserManagement(false)} />}
                        {showApprovals && <ApprovalModal currentUser={currentUser} onClose={() => setShowApprovals(false)} />}
                        {showZoneManagement && currentUser.role === 'manager' && <ZoneManagementModal onClose={() => setShowZoneManagement(false)} />}
                    </>
                );
            }

            const zoneData = getAllZonesData()[currentZone];
            const pendingCount = dataManager.getPendingRequests().length;

            const handleBackToZones = () => {
                setCurrentZone(null);
                setCurrentView('departments');
                setSelectedDepartment(null);
                setSelectedTask(null);
                setSelectedBlock(null);
                setSidebarOpen(false);
            };

            const handleBackToDepartments = () => {
                setCurrentView('departments');
                setSelectedDepartment(null);
                setSelectedTask(null);
                setSelectedBlock(null);
                setSidebarOpen(false);
            };

            const handleBackToTasks = () => {
                setCurrentView('tasks');
                setSelectedTask(null);
                setSelectedBlock(null);
            };

            const handleBackToBlocks = () => {
                setCurrentView('blocks');
                setSelectedBlock(null);
            };

            // ØªØ­Ø¯ÙŠØ¯ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
            const getBackAction = () => {
                if (currentView === 'houses') return handleBackToBlocks;
                if (currentView === 'blocks') return handleBackToTasks;
                if (currentView === 'tasks') return handleBackToDepartments;
                return handleBackToZones;
            };

            return (
                <div className="min-h-screen" style={{ paddingTop: 80 }}>
                    {/* Syncing Overlay */}
                    {isSyncing && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[2000]">
                            <div className="bg-gray-800 p-8 rounded-lg text-center">
                                <div className="flex justify-center mb-4">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
                                </div>
                                <h3 className="text-xl font-bold text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</h3>
                            </div>
                        </div>
                    )}

                    {/* Ø²Ø± AL Ø§Ù„Ø°Ù‡Ø¨ÙŠ */}
                    <button className="al-logo-btn no-print" onClick={() => setSidebarOpen(true)}>AL</button>

                    {/* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */}
                    <button className="back-nav-btn no-print" onClick={getBackAction()}>
                        â†
                    </button>

                    {/* Sidebar Overlay */}
                    <div
                        className={`sidebar-overlay ${sidebarOpen ? 'active' : ''}`}
                        onClick={() => setSidebarOpen(false)}
                    />

                    {/* Sidebar */}
                    <div className={`sidebar-panel ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-header-section">
                            <div style={{ color: 'var(--primary-gold)', fontWeight: 900, fontSize: 13, letterSpacing: 1 }}>AL</div>
                        </div>

                        <div className="sidebar-item" onClick={handleBackToDepartments}>
                            <span className="s-icon">ğŸ </span>
                            <span className="s-label">Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                        </div>

                        <div className="sidebar-item" onClick={() => { setShowSearch(true); setSidebarOpen(false); }}>
                            <span className="s-icon">ğŸ”</span>
                            <span className="s-label">Ø¨Ø­Ø«</span>
                        </div>

                        <div className="sidebar-item" onClick={() => { setShowReport(true); setSidebarOpen(false); }}>
                            <span className="s-icon">ğŸ“Š</span>
                            <span className="s-label">ØªÙ‚Ø§Ø±ÙŠØ±</span>
                        </div>

                        {(currentUser.role === 'manager' || currentUser.role === 'engineer') && (
                            <div className="sidebar-item" onClick={() => { setShowApprovals(true); setSidebarOpen(false); }}>
                                <span className="s-icon">{currentUser.role === 'manager' ? 'âœ‹' : 'ğŸ“'}</span>
                                <span className="s-label">{currentUser.role === 'manager' ? 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Ø·Ù„Ø¨Ø§ØªÙŠ'}</span>
                                {currentUser.role === 'manager' && pendingCount > 0 && (
                                    <span className="sidebar-badge">{pendingCount}</span>
                                )}
                            </div>
                        )}

                        {(currentUser.role === 'admin' || currentUser.role === 'manager') && (
                            <div className="sidebar-item" onClick={() => { setShowUserManagement(true); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ‘¥</span>
                                <span className="s-label">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                            </div>
                        )}

                        {currentUser.role === 'manager' && (
                            <div className="sidebar-item" onClick={() => { setShowZoneManagement(true); setSidebarOpen(false); }}>
                                <span className="s-icon">ğŸ—ï¸</span>
                                <span className="s-label">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                            </div>
                        )}

                        <div className="sidebar-item" onClick={handleBackToZones}>
                            <span className="s-icon">ğŸ—ºï¸</span>
                            <span className="s-label">Ø§Ù„Ø²ÙˆÙ†Ø§Øª</span>
                        </div>

                        <div style={{ marginTop: 'auto' }}>
                            <div className="sidebar-item" style={{ color: '#ef4444' }} onClick={() => setCurrentUser(null)}>
                                <span className="s-icon">ğŸšª</span>
                                <span className="s-label" style={{ color: '#ef4444' }}>Ø®Ø±ÙˆØ¬</span>
                            </div>
                        </div>
                    </div>

                    {/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */}
                    <div className="container mx-auto px-4 py-6">
                        {currentView === 'departments' && (
                            <DepartmentsView
                                zoneData={zoneData}
                                currentUser={currentUser}
                                onSelectDepartment={(dept) => {
                                    setSelectedDepartment(dept);
                                    setCurrentView('tasks');
                                }}
                            />
                        )}
                        {currentView === 'tasks' && (
                            <TasksView
                                zoneData={zoneData}
                                department={selectedDepartment}
                                currentUser={currentUser}
                                onSelectTask={(task) => {
                                    setSelectedTask(task);
                                    setCurrentView('blocks');
                                }}
                                onBack={handleBackToDepartments}
                            />
                        )}
                        {currentView === 'blocks' && (
                            <BlocksView
                                zoneData={zoneData}
                                department={selectedDepartment}
                                task={selectedTask}
                                currentUser={currentUser}
                                onSelectBlock={(block) => {
                                    setSelectedBlock(block);
                                    setCurrentView('houses');
                                }}
                                onBack={handleBackToTasks}
                            />
                        )}
                        {currentView === 'houses' && (
                            <HousesView
                                zoneData={zoneData}
                                block={selectedBlock}
                                department={selectedDepartment}
                                task={selectedTask}
                                currentUser={currentUser}
                                onBack={handleBackToBlocks}
                            />
                        )}
                    </div>

                    {showSearch && <SearchModal zoneData={zoneData} onClose={() => setShowSearch(false)} />}
                    {showReport && <ReportModal currentUser={currentUser} onClose={() => setShowReport(false)} />}
                    {showUserManagement && <UserManagementModal currentUser={currentUser} onClose={() => setShowUserManagement(false)} />}
                    {showApprovals && <ApprovalModal currentUser={currentUser} onClose={() => setShowApprovals(false)} />}
                    {showZoneManagement && currentUser.role === 'manager' && <ZoneManagementModal onClose={() => setShowZoneManagement(false)} />}
                </div>
            );
        }

        // ==================== Departments View ====================
        function DepartmentsView({ zoneData, onSelectDepartment, currentUser }) {
            const getDeptColor = (key) => {
                if (key === 'civil') return '#10b981';
                if (key === 'electrical') return '#f59e0b';
                return '#3b82f6';
            };
            
            // Filter departments based on engineer's specialty
            const departments = currentUser.role === 'engineer' && currentUser.department
                ? { [currentUser.department]: zoneData.departments[currentUser.department] }
                : zoneData.departments;

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="text-center mb-12">
                        <h2 className="text-4xl font-bold text-white mb-3">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</h2>
                        <div className="w-24 h-1 mx-auto" style={{ backgroundColor: 'var(--primary-gold)' }}></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {Object.entries(departments).map(([key, dept]) => (
                            <button
                                key={key}
                                onClick={() => onSelectDepartment(key)}
                                className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-300 hover:-translate-y-2 border-2 border-gray-700 hover:border-gray-600"
                            >
                                <div 
                                    className="absolute top-0 left-0 right-0 h-1.5"
                                    style={{ backgroundColor: getDeptColor(key) }}
                                />

                                <div className="p-10">
                                    <div className="mb-6">
                                        <div 
                                            className="w-24 h-24 mx-auto rounded-2xl flex items-center justify-center text-5xl mb-4 transition-all duration-300 group-hover:scale-110"
                                            style={{ 
                                                backgroundColor: `${getDeptColor(key)}20`,
                                                border: `3px solid ${getDeptColor(key)}40`
                                            }}
                                        >
                                            {dept.icon}
                                        </div>
                                    </div>

                                    <h2 className="text-2xl font-bold text-white text-center mb-4">
                                        {dept.name}
                                    </h2>

                                    <div className="text-center">
                                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-full">
                                            <span className="text-gray-300 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„:</span>
                                            <span className="text-white font-bold">{dept.tasks.length}</span>
                                        </div>
                                    </div>
                                </div>

                                <div 
                                    className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                    style={{ 
                                        background: `linear-gradient(135deg, ${getDeptColor(key)}10 0%, transparent 100%)`
                                    }}
                                />
                            </button>
                        ))}
                    </div>

                    <div className="mt-8 text-center">
                        <p className="text-gray-400 text-sm">
                            Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
                        </p>
                    </div>
                </div>
            );
        }

        // ==================== Tasks View ====================
        function TasksView({ zoneData, department, onSelectTask, onBack, currentUser }) {
            const deptData = zoneData.departments[department];

            const getDeptColor = (key) => {
                if (key === 'civil') return '#10b981';
                if (key === 'electrical') return '#f59e0b';
                return '#3b82f6';
            };
            
            // Filter tasks based on engineer's department if applicable
            let tasks = deptData.tasks;
            // If engineer, only show their department tasks (already filtered in DepartmentsView)
            // So no additional filtering needed here

            return (
                <div>
                    <div className="mb-8">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold"
                        >
                            <span>â†</span>
                            <span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>

                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4" style={{ borderColor: getDeptColor(department) }}>
                        <h2 className="text-3xl font-bold text-white flex items-center gap-3">
                            <span className="text-4xl">{deptData.icon}</span>
                            {deptData.name}
                        </h2>
                        <p className="text-gray-400 mt-2">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {deptData.tasks.map((task, idx) => (
                            <button
                                key={task.id}
                                onClick={() => onSelectTask(task)}
                                className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border-2 border-gray-700 hover:border-gray-600 p-6 text-right"
                            >
                                <div className="flex items-start gap-3">
                                    <div 
                                        className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0"
                                        style={{ backgroundColor: getDeptColor(department) }}
                                    >
                                        {idx + 1}
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="text-lg font-bold text-white leading-relaxed">
                                            {task.name}
                                        </h3>
                                    </div>
                                </div>

                                <div 
                                    className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"
                                    style={{ 
                                        background: `linear-gradient(135deg, ${getDeptColor(department)}10 0%, transparent 100%)`
                                    }}
                                />
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // ==================== Blocks View ====================
        function BlocksView({ zoneData, department, task, onSelectBlock, onBack, currentUser }) {
            const deptData = zoneData.departments[department];
            
            // Filter blocks based on engineer's assigned blocks
            let blocks = zoneData.blocks;
            if (currentUser.role === 'engineer') {
                if (currentUser.zoneBlocks && currentUser.zoneBlocks[zoneData.id]) {
                    // New format: multiple zones
                    blocks = zoneData.blocks.filter(b => currentUser.zoneBlocks[zoneData.id].includes(b.number));
                } else if (currentUser.assignedBlocks && currentUser.assignedZone === zoneData.id) {
                    // Old format: single zone
                    blocks = zoneData.blocks.filter(b => currentUser.assignedBlocks.includes(b.number));
                }
            }

            return (
                <div>
                    <div className="mb-8 flex items-center justify-between">
                        <button
                            onClick={onBack}
                            className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold"
                        >
                            <span>â†</span>
                            <span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>

                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4 border-blue-500">
                        <div className="flex items-center gap-3 mb-2">
                            <span className="text-3xl">{deptData.icon}</span>
                            <h2 className="text-2xl font-bold text-white">
                                {deptData.name}
                            </h2>
                        </div>
                        <p className="text-gray-300 text-lg pr-12">{task.name}</p>
                        <p className="text-gray-400 mt-2 pr-12">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„ÙˆÙƒ</p>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        {blocks.map(block => {
                            let totalHouses = block.houses;
                            let completedHouses = 0;
                            
                            for (let house = 1; house <= block.houses; house++) {
                                const status = dataManager.getStatus(block.number, house, department, task.id);
                                if (status === 'completed') completedHouses++;
                            }
                            
                            const blockProgress = totalHouses > 0 ? Math.round((completedHouses / totalHouses) * 100) : 0;

                            return (
                                <button
                                    key={block.id}
                                    onClick={() => onSelectBlock(block)}
                                    className="group relative bg-gray-800 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border-2 border-gray-700 hover:border-gray-600"
                                >
                                    <div 
                                        className="absolute top-0 left-0 h-1 transition-all duration-500"
                                        style={{ 
                                            width: `${blockProgress}%`,
                                            backgroundColor: blockProgress === 100 ? '#10b981' : blockProgress > 0 ? '#f59e0b' : '#dc2626'
                                        }}
                                    />

                                    <div className="p-6">
                                        <div className="mb-4">
                                            <div className="w-16 h-16 mx-auto rounded-full bg-gray-700 flex items-center justify-center text-3xl mb-3 group-hover:bg-gray-600 transition-colors">
                                                ğŸ—ï¸
                                            </div>
                                            <h3 className="text-xl font-bold text-white text-center">
                                                Ø¨Ù„ÙˆÙƒ {block.number}
                                            </h3>
                                        </div>

                                        <div className="text-center mb-4">
                                            <div className="inline-flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-full">
                                                <span className="text-sm">ğŸ </span>
                                                <span className="text-white text-sm font-semibold">{block.houses} Ø¯Ø§Ø±</span>
                                            </div>
                                        </div>

                                        <div className="space-y-2">
                                            <div className="flex items-center justify-between text-xs">
                                                <span className="text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                                                <span className="text-white font-bold">{blockProgress}%</span>
                                            </div>
                                            <div className="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                                <div 
                                                    className="h-full rounded-full transition-all duration-500"
                                                    style={{ 
                                                        width: `${blockProgress}%`,
                                                        backgroundColor: blockProgress === 100 ? '#10b981' : blockProgress > 0 ? '#f59e0b' : '#dc2626'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="absolute inset-0 bg-gradient-to-t from-gray-900/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none" />
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ==================== Houses View ====================
        function HousesView({ zoneData, block, department, task, currentUser, onBack }) {
            const houses = Array.from({ length: block.houses }, (_, i) => i + 1);
            const [statuses, setStatuses] = useState(() => {
                const init = {};
                houses.forEach(h => { init[h] = dataManager.getStatus(block.number, h, department, task.id); });
                return init;
            });
            const [saveStates, setSaveStates] = useState({});

            const getStatusColor = (s) => s === 'completed' ? '#10b981' : s === 'in-progress' ? '#f59e0b' : '#dc2626';
            const cycleStatus = (s) => s === 'not-started' ? 'in-progress' : s === 'in-progress' ? 'completed' : 'not-started';

            const handleHouseClick = async (houseNum) => {
                if (currentUser.role === 'engineer' && currentUser.department && currentUser.department !== department) {
                    const names = { civil: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©', electrical: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', mechanical: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©' };
                    alert(`â›” Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…\nØ§Ø®ØªØµØ§ØµÙƒ: ${names[currentUser.department]||currentUser.department}`);
                    return;
                }
                const currentStatus = statuses[houseNum] || 'not-started';
                const newStatus = cycleStatus(currentStatus);
                const result = dataManager.updateStatus(block.number, houseNum, department, task.id, newStatus, currentUser.name, currentUser.role);
                if (result === 'approval-needed') {
                    const oldLabel = currentStatus==='completed'?'Ù…Ù†Ø¬Ø²':currentStatus==='in-progress'?'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²':'Ù„Ù… ÙŠØ¨Ø¯Ø£';
                    const newLabel = newStatus==='completed'?'Ù…Ù†Ø¬Ø²':newStatus==='in-progress'?'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²':'Ù„Ù… ÙŠØ¨Ø¯Ø£';
                    alert(`âš ï¸ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\n\nBlock ${block.number} - House ${houseNum}\n${oldLabel} â† ${newLabel}\n\nØ§Ù„ØªØ±Ø§Ø¬Ø¹ ÙŠØ­ØªØ§Ø¬ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±`);
                } else if (result === 'success') {
                    setStatuses(prev => ({ ...prev, [houseNum]: newStatus }));
                    setSaveStates(prev => ({ ...prev, [houseNum]: 'saving' }));
                    try {
                        const p = dataManager.saveData();
                        if (p && typeof p.then === 'function') await p;
                        setSaveStates(prev => ({ ...prev, [houseNum]: 'saved' }));
                        setTimeout(() => setSaveStates(prev => ({ ...prev, [houseNum]: null })), 2500);
                    } catch(e) {
                        setSaveStates(prev => ({ ...prev, [houseNum]: 'error' }));
                        setTimeout(() => setSaveStates(prev => ({ ...prev, [houseNum]: null })), 3000);
                    }
                }
            };

            return (
                <div>
                    <div className="mb-8">
                        <button onClick={onBack} className="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-all flex items-center gap-2 font-semibold">
                            <span>â†</span><span>Ø±Ø¬ÙˆØ¹</span>
                        </button>
                    </div>
                    <div className="mb-8 bg-gray-800 p-6 rounded-xl border-r-4 border-blue-500">
                        <div className="flex items-center justify-between mb-4">
                            <div><h2 className="text-3xl font-bold text-white mb-2">Ø¨Ù„ÙˆÙƒ {block.number}</h2><p className="text-gray-300">{task.name}</p></div>
                            <div className="text-5xl">ğŸ—ï¸</div>
                        </div>
                        <div className="bg-gray-700 p-4 rounded-lg">
                            <div className="flex items-center gap-4 text-sm">
                                {[['#dc2626','Ù„Ù… ÙŠØ¨Ø¯Ø£'],['#f59e0b','Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²'],['#10b981','Ù…Ù†Ø¬Ø²']].map(([c,l]) => (
                                    <div key={l} className="flex items-center gap-2">
                                        <div className="w-4 h-4 rounded" style={{backgroundColor:c}}></div>
                                        <span className="text-gray-300">{l}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-3">
                        {houses.map(houseNum => {
                            const status = statuses[houseNum] || 'not-started';
                            const saveState = saveStates[houseNum];
                            const houseType = getHouseType(zoneData.id, block.number, houseNum);
                            return (
                                <div key={houseNum} className="text-center">
                                    <button onClick={() => handleHouseClick(houseNum)} className="house-box"
                                        style={{ backgroundColor: getStatusColor(status), position: 'relative' }}
                                        disabled={currentUser.role === 'manager'}>
                                        {houseNum}
                                        {saveState === 'saving' && <span style={{position:'absolute',top:3,left:3,width:10,height:10,borderRadius:'50%',border:'2px solid rgba(255,255,255,0.9)',borderTopColor:'transparent',display:'inline-block',animation:'spin 0.7s linear infinite'}}/>}
                                        {saveState === 'saved' && <span style={{position:'absolute',top:3,left:3,width:10,height:10,borderRadius:'50%',backgroundColor:'#fff',display:'flex',alignItems:'center',justifyContent:'center',fontSize:7,color:'#10b981',fontWeight:'bold'}}>âœ“</span>}
                                        {saveState === 'error' && <span style={{position:'absolute',top:3,left:3,width:10,height:10,borderRadius:'50%',backgroundColor:'#ef4444',display:'flex',alignItems:'center',justifyContent:'center',fontSize:7,color:'#fff',fontWeight:'bold'}}>!</span>}
                                    </button>
                                    <div className="text-xs text-gray-400 mt-1">{houseType}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ==================== Search Modal ====================
        function SearchModal({ zoneData, onClose }) {
            const [selectedBlock, setSelectedBlock] = useState('');
            const [houseNumber, setHouseNumber] = useState('');
            const [searchResult, setSearchResult] = useState(null);

            const handleSearch = () => {
                if (!selectedBlock || !houseNumber) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ù„ÙˆÙƒ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª');
                    return;
                }

                const blockNum = parseInt(selectedBlock);
                const houseNum = parseInt(houseNumber);
                const block = zoneData.blocks.find(b => b.number === blockNum);

                if (!block || houseNum < 1 || houseNum > block.houses) {
                    alert('Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª ØºÙŠØ± ØµØ­ÙŠØ­');
                    return;
                }

                const houseType = getHouseType(zoneData.id, blockNum, houseNum);

                const result = {
                    block: blockNum,
                    house: houseNum,
                    type: houseType,
                    details: {}
                };

                Object.entries(zoneData.departments).forEach(([deptKey, dept]) => {
                    result.details[deptKey] = {
                        name: dept.name,
                        icon: dept.icon,
                        tasks: []
                    };

                    dept.tasks.forEach(task => {
                        result.details[deptKey].tasks.push({
                            name: task.name,
                            status: dataManager.getStatus(blockNum, houseNum, deptKey, task.id)
                        });
                    });
                });

                setSearchResult(result);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <h3 className="text-2xl font-bold text-white">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ø±</h3>
                            <button
                                onClick={onClose}
                                className="text-white text-3xl hover:text-red-500 transition"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-white mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„ÙˆÙƒ</label>
                                    <select
                                        value={selectedBlock}
                                        onChange={(e) => setSelectedBlock(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    >
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù„ÙˆÙƒ</option>
                                        {zoneData.blocks.map(block => (
                                            <option key={block.id} value={block.number}>
                                                Ø¨Ù„ÙˆÙƒ {block.number}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-white mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª</label>
                                    <input
                                        type="number"
                                        value={houseNumber}
                                        onChange={(e) => setHouseNumber(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨ÙŠØª"
                                        min="1"
                                    />
                                </div>
                            </div>

                            <button
                                onClick={handleSearch}
                                className="w-full py-3 rounded-lg font-bold text-gray-900 mb-6"
                                style={{ backgroundColor: 'var(--primary-gold)' }}
                            >
                                Ø¨Ø­Ø«
                            </button>

                            {searchResult && (
                                <div className="bg-gray-700 p-6 rounded-lg">
                                    <div className="mb-6">
                                        <h4 className="text-2xl font-bold text-white mb-2">
                                            Ø¨Ù„ÙˆÙƒ {searchResult.block} - Ø¨ÙŠØª {searchResult.house}
                                        </h4>
                                        <p className="text-gray-300">Ù†ÙˆØ¹: {searchResult.type}</p>
                                    </div>

                                    {Object.entries(searchResult.details).map(([deptKey, dept]) => (
                                        <div key={deptKey} className="mb-6">
                                            <h5 className="text-xl font-bold text-white mb-3 flex items-center gap-2">
                                                {dept.icon} {dept.name}
                                            </h5>
                                            <div className="space-y-2">
                                                {dept.tasks.map((task, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-gray-600 p-3 rounded">
                                                        <span className="text-white">{task.name}</span>
                                                        <span className={`font-bold ${
                                                            task.status === 'completed' ? 'text-green-400' :
                                                            task.status === 'in-progress' ? 'text-yellow-400' :
                                                            'text-red-400'
                                                        }`}>
                                                            {task.status === 'completed' ? 'âœ… Ù…Ù†Ø¬Ø²' :
                                                             task.status === 'in-progress' ? 'ğŸŸ¡ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' :
                                                             'ğŸ”´ Ù„Ù… ÙŠØ¨Ø¯Ø£'}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Report Modal ====================
        function ReportModal({ currentUser, onClose }) {
            const [timeLeft, setTimeLeft] = useState('');
            const [viewingReport, setViewingReport] = useState(null);
            const [allReports, setAllReports] = useState([]);
            const [isLoadingReports, setIsLoadingReports] = useState(false);
            const [screen, setScreen] = useState('main');
            const [reportDraft, setReportDraft] = useState({ workers: '', technicians: '', notes: '', changes: [] });
            const [selectedMonth, setSelectedMonth] = useState(() => { const n = new Date(); return { year: n.getFullYear(), month: n.getMonth() }; });
            const [archiveReport, setArchiveReport] = useState(null);

            useEffect(() => {
                if (currentUser.role === 'manager') loadAllReports();
                const tick = () => {
                    const now = new Date();
                    const dl = new Date(); dl.setHours(15, 0, 0, 0);
                    if (now > dl) dl.setDate(dl.getDate() + 1);
                    const diff = dl - now;
                    setTimeLeft(`${Math.floor(diff/3600000)}:${String(Math.floor((diff%3600000)/60000)).padStart(2,'0')}`);
                };
                tick();
                const iv = setInterval(tick, 30000);
                return () => clearInterval(iv);
            }, []);

            const loadAllReports = async () => {
                setIsLoadingReports(true);
                const reports = []; const seen = new Set();
                for (const z of [1, 2, 5]) {
                    try {
                        const raw = localStorage.getItem(`zone${z}_report_history`);
                        if (raw) for (const r of JSON.parse(raw)) { const k = r.submittedAt||(r.date+r.zoneName); if (!seen.has(k)) { seen.add(k); reports.push(r); } }
                    } catch(e) {}
                }
                try {
                    const cd = await cloudSync.syncData();
                    if (cd?.reports) {
                        const arr = Array.isArray(cd.reports) ? cd.reports : Object.values(cd.reports);
                        for (const r of arr) { if (!r) continue; const k = r.submittedAt||(r.date+r.zoneName); if (!seen.has(k)) { seen.add(k); reports.push(r); } }
                    }
                } catch(e) {}
                reports.sort((a,b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                setAllReports(reports);
                setIsLoadingReports(false);
            };

            const sLabel = (ns) => ns === 'completed' ? 'Ù…Ù†Ø¬Ø²' : ns === 'in-progress' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²' : 'Ù„Ù… ÙŠØ¨Ø¯Ø£';
            const sColor = (ns) => ns === 'completed' ? 'text-green-400' : ns === 'in-progress' ? 'text-yellow-400' : 'text-red-400';

            const printReport = (report, changes) => {
                const pw = window.open('', '_blank');
                const rows = (changes||[]).map((c,i) => {
                    const ns = c.newStatus||'';
                    const cls = ns==='completed'?'done':ns==='in-progress'?'wip':'no';
                    return `<tr><td>${i+1}</td><td>Ø¨Ù„ÙˆÙƒ ${c.block}</td><td>Ø¨ÙŠØª ${c.house}</td><td>${c.department||''}</td><td>${c.task||''}</td><td class="${cls}">${sLabel(ns)}</td></tr>`;
                }).join('');
                pw.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ±</title>
                <style>@page{size:A4;margin:18mm}body{font-family:Arial;direction:rtl;color:#000;font-size:13px}
                h1{font-size:20px;color:#C9A961;text-align:center;margin:0 0 4px}h2{font-size:13px;color:#555;text-align:center;margin:0 0 12px;font-weight:normal}
                .line{border-bottom:2px solid #C9A961;margin:0 0 14px}.meta{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px}
                .meta span{background:#f5f0e8;padding:3px 10px;border-radius:6px;font-size:12px}.stats{display:flex;gap:12px;margin-bottom:16px}
                .sbox{flex:1;border:1px solid #C9A961;border-radius:8px;padding:8px;text-align:center}.sval{font-size:24px;font-weight:bold;color:#C9A961}.slbl{font-size:11px;color:#666}
                table{width:100%;border-collapse:collapse;font-size:11px}th{background:#1a3a52;color:#fff;padding:7px 5px;text-align:right}
                td{padding:6px 5px;border-bottom:1px solid #eee}tr:nth-child(even){background:#fafafa}
                .done{color:#16a34a;font-weight:bold}.wip{color:#d97706;font-weight:bold}.no{color:#dc2626;font-weight:bold}
                .notes{margin-top:14px;border:1px solid #ddd;border-radius:8px;padding:10px;font-size:12px}
                .footer{margin-top:28px;display:flex;justify-content:space-between}.sign{border-top:1px solid #999;width:170px;padding-top:4px;text-align:center;font-size:12px}</style></head>
                <body><h1>ALFARAH - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1><h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2><div class="line"></div>
                <div class="meta">
                  <span>ğŸ“… ${report.date||new Date().toLocaleDateString('en-GB')}</span>
                  <span>â° ${report.time||new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</span>
                  <span>ğŸ‘¤ ${report.preparedBy||currentUser.name}</span>
                  <span>ğŸ—ï¸ ${report.zoneName||dataManager.getZoneData()?.name||''}</span>
                </div>
                <div class="stats">
                  <div class="sbox"><div class="sval">${report.workers||0}</div><div class="slbl">ğŸ‘· Ø§Ù„Ø¹Ù…Ø§Ù„</div></div>
                  <div class="sbox"><div class="sval">${report.technicians||0}</div><div class="slbl">ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div></div>
                  <div class="sbox"><div class="sval">${(changes||[]).length}</div><div class="slbl">ğŸ“ˆ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</div></div>
                </div>
                <table><thead><tr><th>#</th><th>Ø§Ù„Ø¨Ù„ÙˆÙƒ</th><th>Ø§Ù„Ø¨ÙŠØª</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody>${rows||'<tr><td colspan="6" style="text-align:center;color:#888;padding:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª</td></tr>'}</tbody></table>
                ${report.notes?`<div class="notes"><strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${report.notes}</div>`:''}
                <div class="footer"><div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³<br>${report.preparedBy||currentUser.name}</div><div class="sign">ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div></div>
                </body></html>`);
                pw.document.close(); setTimeout(() => pw.print(), 400);
            };

            const ChangesList = ({ changes }) => (
                <div className="space-y-2 max-h-96 overflow-y-auto">
                    {!changes||changes.length===0 ? <p className="text-gray-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª</p>
                    : changes.map((c,i) => (
                        <div key={i} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center text-sm">
                            <div>
                                <span className="text-white font-bold">Ø¨Ù„ÙˆÙƒ {c.block} - Ø¨ÙŠØª {c.house}</span>
                                <span className="text-gray-400 mx-1">|</span>
                                <span className="text-gray-300">{c.task}</span>
                            </div>
                            <span className={`font-bold ${sColor(c.newStatus||'')}`}>{sLabel(c.newStatus||'')}</span>
                        </div>
                    ))}
                </div>
            );

            const ReportDetailView = ({ report, changes, onBack }) => (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-lg font-bold text-white">{report.date} | {report.preparedBy}</h3>
                                <p className="text-gray-400 text-sm">{report.zoneName}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => printReport(report, changes)} className="px-4 py-2 rounded-lg font-bold text-gray-900 text-sm" style={{backgroundColor:'var(--primary-gold)'}}>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
                                <button onClick={onBack} className="text-white text-2xl hover:text-red-500 leading-none">Ã—</button>
                            </div>
                        </div>
                        <div className="p-4 space-y-3">
                            <div className="grid grid-cols-3 gap-3">
                                {[['ğŸ‘·',report.workers||0,'Ø¹Ù…Ø§Ù„'],['ğŸ”§',report.technicians||0,'ÙÙ†ÙŠÙŠÙ†'],['ğŸ“ˆ',(changes||[]).length,'ØªØºÙŠÙŠØ±']].map(([ic,v,l]) => (
                                    <div key={l} className="bg-gray-700 p-3 rounded-lg text-center">
                                        <div className="text-2xl font-bold text-white">{v}</div>
                                        <div className="text-xs text-gray-400">{ic} {l}</div>
                                    </div>
                                ))}
                            </div>
                            {report.notes && <div className="bg-gray-700 p-3 rounded-lg text-sm text-gray-300">ğŸ“ {report.notes}</div>}
                            <ChangesList changes={changes} />
                        </div>
                    </div>
                </div>
            );

            // ===== Ø§Ù„Ù…Ø¯ÙŠØ± =====
            if (currentUser.role === 'manager') {
                if (viewingReport) return <ReportDetailView report={viewingReport} changes={viewingReport.changes||[]} onBack={() => setViewingReport(null)} />;
                const today = new Date().toLocaleDateString('en-GB');
                const todayReports = allReports.filter(r => r.date === today);
                const archiveReports = allReports.filter(r => r.date !== today);
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</h3>
                                    <p className="text-gray-400 text-sm">{today} | {todayReports.length} ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={loadAllReports} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ğŸ”„</button>
                                    <button onClick={onClose} className="text-white text-3xl hover:text-red-500 leading-none">Ã—</button>
                                </div>
                            </div>
                            <div className="p-4 space-y-3">
                                {isLoadingReports ? (
                                    <div className="text-center py-10"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500 mx-auto mb-3"></div><p className="text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
                                ) : todayReports.length === 0 ? (
                                    <div className="text-center py-10"><div className="text-5xl mb-2">ğŸ“­</div><p className="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</p></div>
                                ) : todayReports.map((report, idx) => {
                                    const changes = report.changes||[];
                                    return (
                                        <div key={idx} className="bg-gray-700 p-4 rounded-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <div>
                                                    <div className="font-bold text-white text-lg">{report.preparedBy}</div>
                                                    <div className="text-sm text-gray-400">{report.zoneName} | {report.time}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setViewingReport(report)} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                                                    <button onClick={() => printReport(report, changes)} className="px-3 py-2 rounded-lg text-sm font-bold text-gray-900" style={{backgroundColor:'var(--primary-gold)'}}>ğŸ–¨ï¸</button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                {[['ğŸ‘·',report.workers||0,'Ø¹Ù…Ø§Ù„'],['ğŸ”§',report.technicians||0,'ÙÙ†ÙŠÙŠÙ†'],['ğŸ“ˆ',changes.length,'ØªØºÙŠÙŠØ±']].map(([ic,v,l]) => (
                                                    <div key={l} className="bg-gray-600 p-2 rounded-lg text-center">
                                                        <div className="font-bold text-white">{v}</div>
                                                        <div className="text-xs text-gray-400">{ic} {l}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                                {archiveReports.length > 0 && (
                                    <div className="bg-gray-700 p-4 rounded-xl">
                                        <h4 className="font-bold text-white mb-3">ğŸ—ƒï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ({archiveReports.length})</h4>
                                        <div className="space-y-2 max-h-48 overflow-y-auto">
                                            {archiveReports.map((r,i) => (
                                                <div key={i} className="bg-gray-600 p-3 rounded-lg flex items-center justify-between">
                                                    <div>
                                                        <span className="font-bold text-white">{r.date}</span>
                                                        <span className="text-gray-400 text-sm mx-2">|</span>
                                                        <span className="text-gray-300 text-sm">{r.preparedBy} - {r.zoneName}</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setViewingReport(r)} className="px-3 py-1 bg-blue-600 text-white rounded text-sm">ğŸ‘ï¸</button>
                                                        <button onClick={() => printReport(r, r.changes||[])} className="px-3 py-1 bg-gray-500 text-white rounded text-sm">ğŸ–¨ï¸</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // ===== Ø£Ø±Ø´ÙŠÙ ØªÙØ§ØµÙŠÙ„ =====
            if (screen === 'archiveDetail' && archiveReport) {
                return <ReportDetailView report={archiveReport} changes={archiveReport.changes||[]} onBack={() => setScreen('archive')} />;
            }

            // ===== Ø£Ø±Ø´ÙŠÙ ØªÙ‚ÙˆÙŠÙ… =====
            if (screen === 'archive') {
                const { year, month } = selectedMonth;
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const monthName = new Date(year, month, 1).toLocaleDateString('en-GB', {month:'long',year:'numeric'});
                const reportMap = {};
                dataManager.reportHistory.forEach(r => {
                    const key = r.submittedAt ? r.submittedAt.split('T')[0] : null;
                    if (key && !reportMap[key]) reportMap[key] = r;
                });
                const today = new Date();
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-xl max-w-sm w-full">
                            <div className="p-4 border-b border-gray-700 flex items-center justify-between">
                                <h3 className="text-xl font-bold text-white">ğŸ—ƒï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                                <button onClick={() => setScreen('main')} className="text-white text-2xl hover:text-red-500 leading-none">Ã—</button>
                            </div>
                            <div className="p-4 space-y-4">
                                <div className="flex items-center justify-between">
                                    <button onClick={() => setSelectedMonth(p => { const d=new Date(p.year,p.month-1,1); return {year:d.getFullYear(),month:d.getMonth()}; })}
                                        className="w-10 h-10 bg-gray-700 text-white rounded-lg text-xl flex items-center justify-center hover:bg-gray-600">â€¹</button>
                                    <span className="font-bold text-white">{monthName}</span>
                                    <button onClick={() => setSelectedMonth(p => { const d=new Date(p.year,p.month+1,1); return {year:d.getFullYear(),month:d.getMonth()}; })}
                                        className="w-10 h-10 bg-gray-700 text-white rounded-lg text-xl flex items-center justify-center hover:bg-gray-600">â€º</button>
                                </div>
                                <div className="bg-gray-700 p-3 rounded-xl">
                                    <div className="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2 font-bold">
                                        {['Su','Mo','Tu','We','Th','Fr','Sa'].map(d => <div key={d}>{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1">
                                        {Array.from({length:firstDay},(_,i) => <div key={'e'+i}/>)}
                                        {Array.from({length:daysInMonth},(_,i) => {
                                            const day = i+1;
                                            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                            const report = reportMap[dateStr];
                                            const isToday = day===today.getDate() && month===today.getMonth() && year===today.getFullYear();
                                            return (
                                                <button key={day} onClick={() => { if(report){setArchiveReport(report);setScreen('archiveDetail');} }}
                                                    className={`py-2 rounded-lg text-sm font-bold transition-all ${report?'bg-blue-600 text-white hover:bg-blue-500 shadow-md':isToday?'border-2 border-yellow-500 text-yellow-400':'text-gray-600 cursor-default'}`}>
                                                    {day}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                                <p className="text-center text-gray-500 text-xs">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ = ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù…ØµØ¯Ù‘Ø±</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // ===== Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± =====
            if (screen === 'create') {
                const { workers, technicians, notes, changes } = reportDraft;
                const handleExport = () => {
                    if (!workers && !technicians) { alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø£Ùˆ Ø§Ù„ÙÙ†ÙŠÙŠÙ†'); return; }
                    const now = new Date();
                    const reportData = {
                        workers: parseInt(workers)||0, technicians: parseInt(technicians)||0,
                        notes, changes, totalChanges: changes.length,
                        preparedBy: currentUser.name,
                        zoneName: dataManager.getZoneData()?.name || '',
                        zoneId: dataManager.zoneId,
                        date: now.toLocaleDateString('en-GB'),
                        time: now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit'}),
                        submittedAt: now.toISOString()
                    };
                    dataManager.submitReport(reportData);
                    printReport(reportData, changes);
                    setScreen('main');
                };
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-xl max-w-xl w-full max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-800 p-4 border-b border-gray-700 flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white">ğŸ“‹ ØªÙ‚Ø±ÙŠØ± {new Date().toLocaleDateString('en-GB')}</h3>
                                    <p className="text-gray-400 text-sm">{changes.length} ØªØºÙŠÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</p>
                                </div>
                                <button onClick={() => setScreen('main')} className="text-white text-3xl hover:text-red-500 leading-none">Ã—</button>
                            </div>
                            <div className="p-4 space-y-4">
                                <div className="bg-gray-700 rounded-xl overflow-hidden">
                                    <div className="px-4 py-3 border-b border-gray-600">
                                        <h4 className="font-bold text-white">Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ({changes.length})</h4>
                                    </div>
                                    {changes.length === 0 ? (
                                        <p className="text-gray-400 text-center py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                                    ) : (
                                        <div className="divide-y divide-gray-600 max-h-52 overflow-y-auto">
                                            {changes.map((c,i) => (
                                                <div key={i} className="flex justify-between items-center px-4 py-3 text-sm">
                                                    <div>
                                                        <span className="text-white font-bold">Ø¨Ù„ÙˆÙƒ {c.block} - Ø¨ÙŠØª {c.house}</span>
                                                        <span className="text-gray-400 mx-1">|</span>
                                                        <span className="text-gray-300">{c.task}</span>
                                                    </div>
                                                    <span className={`font-bold ${sColor(c.newStatus||'')}`}>{sLabel(c.newStatus||'')}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-gray-700 p-4 rounded-xl space-y-3">
                                    <h4 className="font-bold text-white">Ø§Ù„Ù‚ÙˆÙ‰ Ø§Ù„Ø¹Ø§Ù…Ù„Ø©</h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-gray-400 text-xs block mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„</label>
                                            <input type="number" value={workers} min="0" placeholder="0"
                                                onChange={e => setReportDraft(p => ({...p,workers:e.target.value}))}
                                                className="w-full px-3 py-3 bg-gray-600 text-white rounded-lg text-center text-2xl font-bold"/>
                                        </div>
                                        <div>
                                            <label className="text-gray-400 text-xs block mb-1">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙ†ÙŠÙŠÙ†</label>
                                            <input type="number" value={technicians} min="0" placeholder="0"
                                                onChange={e => setReportDraft(p => ({...p,technicians:e.target.value}))}
                                                className="w-full px-3 py-3 bg-gray-600 text-white rounded-lg text-center text-2xl font-bold"/>
                                        </div>
                                    </div>
                                    <textarea value={notes} rows={2} placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."
                                        onChange={e => setReportDraft(p => ({...p,notes:e.target.value}))}
                                        className="w-full px-3 py-2 bg-gray-600 text-white rounded-lg resize-none text-sm"/>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setScreen('main')} className="flex-1 py-3 bg-gray-600 text-white rounded-xl font-bold text-lg hover:bg-gray-500">â† Ø±Ø¬ÙˆØ¹</button>
                                    <button onClick={handleExport} className="flex-1 py-3 rounded-xl font-bold text-gray-900 text-lg" style={{backgroundColor:'var(--primary-gold)'}}>ğŸ“¤ ØªØµØ¯ÙŠØ± ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // ===== Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-xl max-w-xs w-full">
                        <div className="p-4 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                                <p className="text-gray-400 text-sm">{new Date().toLocaleDateString('en-GB')} | â° {timeLeft}</p>
                            </div>
                            <button onClick={onClose} className="text-white text-3xl hover:text-red-500 leading-none">Ã—</button>
                        </div>
                        <div className="p-5 space-y-3">
                            <button onClick={() => {
                                const changes = dataManager.getTodayChanges();
                                setReportDraft({ workers:'', technicians:'', notes:'', changes });
                                setScreen('create');
                            }} className="w-full py-5 rounded-xl font-bold text-gray-900 text-xl flex items-center justify-center gap-3"
                                style={{backgroundColor:'var(--primary-gold)'}}>
                                <span className="text-2xl">â•</span> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ±
                            </button>
                            <button onClick={() => setScreen('archive')}
                                className="w-full py-4 bg-gray-700 text-white rounded-xl font-bold text-lg hover:bg-gray-600 flex items-center justify-center gap-3">
                                <span className="text-xl">ğŸ—ƒï¸</span> Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Approval Modal ====================
        function ApprovalModal({ currentUser, onClose }) {
            const [requests, setRequests] = useState([]);
            const [refreshKey, setRefreshKey] = useState(0);
            const [loadingId, setLoadingId] = useState(null); // id Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø°ÙŠ ÙŠÙØ¹Ø§Ù„Ø¬ Ø­Ø§Ù„ÙŠØ§Ù‹

            useEffect(() => {
                loadRequests();
            }, [refreshKey]);

            const loadRequests = () => {
                if (currentUser.role === 'manager') {
                    setRequests(dataManager.getPendingRequests());
                } else {
                    setRequests(dataManager.getMyRequests(currentUser.name));
                }
            };

            const handleApprove = async (requestId) => {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
                setLoadingId(requestId);
                try {
                    const success = dataManager.approveRequest(requestId);
                    if (success) {
                        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                        await dataManager.saveData();
                        setRefreshKey(prev => prev + 1);
                    } else {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©');
                    }
                } catch(e) {
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
                } finally {
                    setLoadingId(null);
                }
            };

            const handleReject = async (requestId) => {
                if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
                setLoadingId(requestId);
                try {
                    const success = dataManager.rejectRequest(requestId, '');
                    if (success) {
                        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                        await dataManager.saveData();
                        setRefreshKey(prev => prev + 1);
                    } else {
                        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¶');
                    }
                } catch(e) {
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
                } finally {
                    setLoadingId(null);
                }
            };

            const getStatusBadge = (status) => {
                if (status === 'pending') {
                    return <span className="px-3 py-1 bg-yellow-600 text-white rounded-full text-sm">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>;
                } else if (status === 'approved') {
                    return <span className="px-3 py-1 bg-green-600 text-white rounded-full text-sm">âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>;
                } else {
                    return <span className="px-3 py-1 bg-red-600 text-white rounded-full text-sm">âŒ Ù…Ø±ÙÙˆØ¶</span>;
                }
            };

            const Spinner = () => (
                <span style={{
                    display: 'inline-block', width: 18, height: 18,
                    border: '2.5px solid rgba(255,255,255,0.3)',
                    borderTopColor: '#fff',
                    borderRadius: '50%',
                    animation: 'spin 0.7s linear infinite',
                    verticalAlign: 'middle'
                }} />
            );

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-2xl font-bold text-white">
                                    {currentUser.role === 'manager' ? 'âœ‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'ğŸ“ Ø·Ù„Ø¨Ø§ØªÙŠ'}
                                </h3>
                                {currentUser.role === 'manager' && (
                                    <p className="text-gray-400 text-sm mt-1">
                                        {requests.length} Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                    </p>
                                )}
                            </div>
                            <button onClick={onClose} className="text-white text-3xl hover:text-red-500 transition">Ã—</button>
                        </div>

                        <div className="p-6">
                            {requests.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">
                                        {currentUser.role === 'manager' ? 'âœ…' : 'ğŸ“­'}
                                    </div>
                                    <p className="text-gray-400 text-lg">
                                        {currentUser.role === 'manager'
                                            ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙˆØ§ÙÙ‚Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'
                                            : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø±Ø³Ù„Ø©'
                                        }
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {requests.map((request) => {
                                        const isLoading = loadingId === request.id;
                                        return (
                                            <div key={request.id} className="bg-gray-700 p-6 rounded-lg">
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <h4 className="text-xl font-bold text-white">
                                                                {request.zoneName} - Ø¨Ù„ÙˆÙƒ {request.block} - Ø¨ÙŠØª {request.house}
                                                            </h4>
                                                            {getStatusBadge(request.status)}
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 text-sm text-gray-300 mb-3">
                                                            <div>ğŸ“… {request.timestampDisplay}</div>
                                                            <div>ğŸ‘¤ {request.username}</div>
                                                            <div>ğŸ“‚ {request.departmentName}</div>
                                                            <div>ğŸ”§ {request.taskName}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="bg-gray-600 p-4 rounded-lg mb-4">
                                                    <div className="flex items-center justify-center gap-8">
                                                        <div className="text-center">
                                                            <div className="text-sm text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                                                            <div className={`text-lg font-bold ${
                                                                request.oldStatus === 'completed' ? 'text-green-400' :
                                                                request.oldStatus === 'in-progress' ? 'text-yellow-400' :
                                                                'text-red-400'
                                                            }`}>{request.oldStatusText}</div>
                                                        </div>
                                                        <div className="text-3xl">â†’</div>
                                                        <div className="text-center">
                                                            <div className="text-sm text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
                                                            <div className={`text-lg font-bold ${
                                                                request.newStatus === 'completed' ? 'text-green-400' :
                                                                request.newStatus === 'in-progress' ? 'text-yellow-400' :
                                                                'text-red-400'
                                                            }`}>{request.newStatusText}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {currentUser.role === 'manager' && request.status === 'pending' && (
                                                    <div className="flex gap-3">
                                                        <button
                                                            onClick={() => handleApprove(request.id)}
                                                            disabled={isLoading}
                                                            className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold flex items-center justify-center gap-2 disabled:opacity-60"
                                                        >
                                                            {isLoading ? <Spinner /> : 'âœ…'} Ù…ÙˆØ§ÙÙ‚Ø©
                                                        </button>
                                                        <button
                                                            onClick={() => handleReject(request.id)}
                                                            disabled={isLoading}
                                                            className="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold flex items-center justify-center gap-2 disabled:opacity-60"
                                                        >
                                                            {isLoading ? <Spinner /> : 'âŒ'} Ø±ÙØ¶
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== User Management Modal ====================
        function UserManagementModal({ currentUser, onClose }) {
            const [showAddUser, setShowAddUser] = useState(false);
            const [showChangePassword, setShowChangePassword] = useState(null);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-6 border-b border-gray-700 flex items-center justify-between">
                            <h3 className="text-2xl font-bold text-white">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
                            <button
                                onClick={onClose}
                                className="text-white text-3xl hover:text-red-500 transition"
                            >
                                Ã—
                            </button>
                        </div>

                        <div className="p-6">
                            <div className="mb-6">
                                <div className="bg-gray-700 p-4 rounded-lg mb-4">
                                    <h4 className="text-white font-bold mb-2">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                                    <p className="text-gray-300">Ø§Ù„Ø§Ø³Ù…: {currentUser.name}</p>
                                    <p className="text-gray-300">
                                        Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: {
                                            currentUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' :
                                            currentUser.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' :
                                            'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹'
                                        }
                                    </p>
                                </div>

                                {(currentUser.role === 'admin' || currentUser.role === 'manager') && (
                                    <>
                                        <button
                                            onClick={() => setShowAddUser(true)}
                                            className="w-full py-3 rounded-lg font-bold text-gray-900 mb-4"
                                            style={{ backgroundColor: 'var(--primary-gold)' }}
                                        >
                                            â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                                        </button>

                                        <div className="space-y-3">
                                            <h4 className="text-white font-bold mb-3">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h4>
                                            {userManager.getVisibleUsers().map(user => (
                                                <div key={user.id} className="bg-gray-700 p-4 rounded-lg">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div>
                                                            <p className="text-white font-bold">{user.name}</p>
                                                            <p className="text-gray-400 text-sm">
                                                                {user.role === 'manager' ? 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹' : 'Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹'}
                                                            </p>
                                                            {user.role === 'engineer' && user.department && (
                                                                <div className="mt-2 space-y-1">
                                                                    <p className="text-gray-300 text-sm">
                                                                        <span className="font-semibold">Ø§Ù„ØªØ®ØµØµ:</span> {
                                                                            user.department === 'civil' ? 'ğŸ—ï¸ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©' :
                                                                            user.department === 'electrical' ? 'âš¡ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©' :
                                                                            'ğŸ”§ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©'
                                                                        }
                                                                    </p>
                                                                    {user.assignedZones && user.assignedZones.length > 0 && (
                                                                        <div className="text-gray-300 text-sm">
                                                                            <span className="font-semibold">Ø§Ù„Ø²ÙˆÙ†Ø§Øª:</span>
                                                                            <div className="mr-4 mt-1 space-y-1">
                                                                                {user.assignedZones.map(zoneId => (
                                                                                    <div key={zoneId}>
                                                                                        <span className="text-blue-400">â€¢ {
                                                                                            zoneId === 1 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' :
                                                                                            zoneId === 2 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                                                                            'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³'
                                                                                        }</span>
                                                                                        {user.zoneBlocks && user.zoneBlocks[zoneId] && (
                                                                                            <span className="text-gray-400 mr-2">
                                                                                                (Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª: {user.zoneBlocks[zoneId].sort((a, b) => a - b).join(', ')})
                                                                                            </span>
                                                                                        )}
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                    {/* Support old format */}
                                                                    {user.assignedZone && !user.assignedZones && (
                                                                        <>
                                                                            <p className="text-gray-300 text-sm">
                                                                                <span className="font-semibold">Ø§Ù„Ø²ÙˆÙ†:</span> {
                                                                                    user.assignedZone === 1 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' :
                                                                                    user.assignedZone === 2 ? 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' :
                                                                                    'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³'
                                                                                }
                                                                            </p>
                                                                            {user.assignedBlocks && user.assignedBlocks.length > 0 && (
                                                                                <p className="text-gray-300 text-sm">
                                                                                    <span className="font-semibold">Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª:</span> {user.assignedBlocks.sort((a, b) => a - b).join(', ')}
                                                                                </p>
                                                                            )}
                                                                        </>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => setShowChangePassword(user)}
                                                                className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                                title="ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                                                            >
                                                                ğŸ”‘
                                                            </button>
                                                            {currentUser.role === 'admin' && (
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${user.name}ØŸ`)) {
                                                                            userManager.deleteUser(user.id);
                                                                            window.location.reload();
                                                                        }
                                                                    }}
                                                                    className="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                                                    title="Ø­Ø°Ù"
                                                                >
                                                                    ğŸ—‘ï¸
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>

                            <div className="bg-gray-700 p-4 rounded-lg">
                                <h4 className="text-white font-bold mb-3">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
                                <p className="text-gray-300 text-sm mb-3">
                                    Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
                                </p>
                                <button
                                    onClick={() => {
                                        const code = userManager.exportUsersCode();
                                        const textarea = document.createElement('textarea');
                                        textarea.value = code;
                                        document.body.appendChild(textarea);
                                        textarea.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(textarea);
                                        
                                        alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯!\n\n` +
                                              `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${userManager.users.length}\n\n` +
                                              `ğŸ“± ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø±:\n` +
                                              `1. Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù\n` +
                                              `2. Ø§Ø¶ØºØ· "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† ÙƒÙˆØ¯"\n` +
                                              `3. Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯\n\n` +
                                              `Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†Ø³ÙˆØ® ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¢Ù†!`);
                                    }}
                                    className="w-full py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-bold"
                                >
                                    ğŸ“¤ Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                                </button>
                            </div>

                            {currentUser.role === 'admin' && (
                                <div className="bg-red-900 bg-opacity-40 border border-red-600 p-4 rounded-lg">
                                    <h4 className="text-red-400 font-bold mb-2">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø± - Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·</h4>
                                    <p className="text-gray-300 text-sm mb-3">
                                        Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ù„Ø£Ù†Ø´Ø·Ø©ØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆÙ†Ø§ØªØŒ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©. <strong className="text-red-400">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!</strong>
                                    </p>
                                    <button
                                        onClick={async () => {
                                            const confirmed1 = confirm('âš ï¸ ØªØ­Ø°ÙŠØ±!\n\nØ£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ');
                                            if (!confirmed1) return;
                                            const confirmed2 = confirm('ğŸ”´ ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±!\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆÙ†Ø§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±\nâ€¢ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!\n\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.');
                                            if (!confirmed2) return;
                                            const success = await cloudSync.deleteAllData();
                                            if (success) {
                                                alert('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\nØ³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                                                window.location.reload();
                                            } else {
                                                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                                            }
                                        }}
                                        className="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold text-lg"
                                    >
                                        ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    </button>
                                </div>
                            )}

                            <div className="bg-gray-700 p-4 rounded-lg">
                                <h4 className="text-white font-bold mb-3">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (GitHub Gist)</h4>
                                <p className="text-gray-300 text-sm mb-3">
                                    {cloudSync.gistId 
                                        ? `âœ… Ù…ØªØµÙ„ Ø¨Ù€ Gist: ${cloudSync.gistId.substring(0, 8)}...`
                                        : 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø¹Ø¯ - Ø³ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„'
                                    }
                                </p>
                                <div className="flex gap-3">
                                    <button
                                        onClick={async () => {
                                            const success = await cloudSync.exportData();
                                            if (success) {
                                                alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                                            } else {
                                                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±');
                                            }
                                        }}
                                        className="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                                    >
                                        ğŸ“¥ ØªØµØ¯ÙŠØ± CSV
                                    </button>
                                    <button
                                        onClick={async () => {
                                            const data = await cloudSync.syncData();
                                            if (data) {
                                                alert(`âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©\n\nğŸ“Š Ø§Ù„Ø£Ù†Ø´Ø·Ø©: ${data.activities?.length || 0}\nğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±: ${data.reports?.length || 0}\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${data.users?.length || 0}`);
                                            } else {
                                                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                                            }
                                        }}
                                        className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        ğŸ”„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
                                    </button>
                                </div>
                                {cloudSync.gistId && (
                                    <button
                                        onClick={() => {
                                            const gistUrl = `https://gist.github.com/${cloudSync.gistId}`;
                                            navigator.clipboard.writeText(gistUrl);
                                            alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Gist!\n\nğŸ”— ${gistUrl}\n\nğŸ’¡ Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰\nÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø±: Ø§Ø¶ØºØ· "ğŸ”— Ø±Ø¨Ø· Ù…Ø¹ Gist Ù…ÙˆØ¬ÙˆØ¯"`);
                                        }}
                                        className="w-full py-3 mt-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
                                    >
                                        ğŸ”— Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Gist
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {showAddUser && (
                        <AddUserModal 
                            currentUserRole={currentUser.role}
                            onClose={() => setShowAddUser(false)}
                            onAdd={() => {
                                setShowAddUser(false);
                                window.location.reload();
                            }}
                        />
                    )}

                    {showChangePassword && (
                        <ChangePasswordModal
                            user={showChangePassword}
                            onClose={() => setShowChangePassword(null)}
                            onSuccess={() => {
                                setShowChangePassword(null);
                                alert('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
                            }}
                        />
                    )}
                </div>
            );
        }

        // ==================== Add User Modal ====================
        function AddUserModal({ currentUserRole, onClose, onAdd }) {
            const [name, setName] = useState('');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('engineer');
            const [department, setDepartment] = useState('civil');
            const [assignedZones, setAssignedZones] = useState([]);
            const [zoneBlocks, setZoneBlocks] = useState({});

            const zones = [
                { id: 1, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„' },
                { id: 2, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ' },
                { id: 5, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³' }
            ];

            const departments = [
                { id: 'civil', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠØ©', icon: 'ğŸ—ï¸' },
                { id: 'electrical', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', icon: 'âš¡' },
                { id: 'mechanical', name: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', icon: 'ğŸ”§' }
            ];

            const toggleZone = (zoneId) => {
                if (assignedZones.includes(zoneId)) {
                    // Remove zone
                    setAssignedZones(assignedZones.filter(z => z !== zoneId));
                    const newZoneBlocks = { ...zoneBlocks };
                    delete newZoneBlocks[zoneId];
                    setZoneBlocks(newZoneBlocks);
                } else {
                    // Add zone
                    setAssignedZones([...assignedZones, zoneId]);
                    setZoneBlocks({ ...zoneBlocks, [zoneId]: [] });
                }
            };

            const toggleBlock = (zoneId, blockNumber) => {
                const blocks = zoneBlocks[zoneId] || [];
                if (blocks.includes(blockNumber)) {
                    setZoneBlocks({
                        ...zoneBlocks,
                        [zoneId]: blocks.filter(b => b !== blockNumber)
                    });
                } else {
                    setZoneBlocks({
                        ...zoneBlocks,
                        [zoneId]: [...blocks, blockNumber]
                    });
                }
            };

            const selectAllBlocks = (zoneId) => {
                const allBlocks = ZONES_DATA[zoneId]?.blocks.map(b => b.number) || [];
                setZoneBlocks({
                    ...zoneBlocks,
                    [zoneId]: allBlocks
                });
            };

            const clearAllBlocks = (zoneId) => {
                setZoneBlocks({
                    ...zoneBlocks,
                    [zoneId]: []
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (role === 'engineer') {
                    if (assignedZones.length === 0) {
                        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø²ÙˆÙ† ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³');
                        return;
                    }
                    
                    // Check if all zones have blocks assigned
                    for (const zoneId of assignedZones) {
                        if (!zoneBlocks[zoneId] || zoneBlocks[zoneId].length === 0) {
                            alert(`Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¨Ù„ÙˆÙƒØ§Øª Ù„Ù„Ø²ÙˆÙ† ${zoneId}`);
                            return;
                        }
                    }
                }
                
                userManager.addUser({
                    name,
                    username,
                    password,
                    role,
                    department: role === 'engineer' ? department : null,
                    assignedZones: role === 'engineer' ? assignedZones : null,
                    zoneBlocks: role === 'engineer' ? zoneBlocks : null,
                    hidden: false
                });

                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
                      `ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}\n` +
                      `ğŸ”‘ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}\n` +
                      `ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${password}\n\n` +
                      `â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...\n` +
                      `Ø§Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†ÙŠ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±`);
                
                onAdd();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
                    <div className="bg-gray-800 rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold text-white mb-6">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-white mb-2">Ø§Ù„Ø§Ø³Ù…</label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-white mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-white mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-white mb-2">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                <select
                                    value={role}
                                    onChange={(e) => setRole(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                >
                                    {currentUserRole === 'admin' && (
                                        <option value="manager">Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹</option>
                                    )}
                                    <option value="engineer">Ù…Ù‡Ù†Ø¯Ø³ Ù…ÙˆÙ‚Ø¹</option>
                                </select>
                            </div>

                            {role === 'engineer' && (
                                <>
                                    <div>
                                        <label className="block text-white mb-2">Ø§Ù„ØªØ®ØµØµ</label>
                                        <select
                                            value={department}
                                            onChange={(e) => setDepartment(e.target.value)}
                                            className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                        >
                                            {departments.map(dept => (
                                                <option key={dept.id} value={dept.id}>
                                                    {dept.icon} {dept.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-white mb-2">Ø§Ù„Ø²ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø²ÙˆÙ†)</label>
                                        <div className="grid grid-cols-3 gap-3 p-4 bg-gray-700 rounded-lg">
                                            {zones.map(zone => (
                                                <button
                                                    key={zone.id}
                                                    type="button"
                                                    onClick={() => toggleZone(zone.id)}
                                                    className={`p-4 rounded-lg text-center transition ${
                                                        assignedZones.includes(zone.id)
                                                            ? 'bg-green-600 text-white ring-2 ring-green-400'
                                                            : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                                    }`}
                                                >
                                                    <div className="font-bold">{zone.name}</div>
                                                    {assignedZones.includes(zone.id) && (
                                                        <div className="text-sm mt-1">âœ…</div>
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {assignedZones.map(zoneId => (
                                        <div key={zoneId} className="bg-gray-700 p-4 rounded-lg">
                                            <div className="flex items-center justify-between mb-3">
                                                <h4 className="text-white font-bold">
                                                    Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© - {zones.find(z => z.id === zoneId)?.name}
                                                </h4>
                                                <div className="flex gap-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => selectAllBlocks(zoneId)}
                                                        className="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                    >
                                                        ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => clearAllBlocks(zoneId)}
                                                        className="text-xs px-3 py-1 bg-gray-600 text-white rounded hover:bg-gray-700"
                                                    >
                                                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-5 md:grid-cols-8 gap-2">
                                                {ZONES_DATA[zoneId]?.blocks.map(block => (
                                                    <button
                                                        key={block.number}
                                                        type="button"
                                                        onClick={() => toggleBlock(zoneId, block.number)}
                                                        className={`p-2 rounded-lg text-center transition text-sm ${
                                                            (zoneBlocks[zoneId] || []).includes(block.number)
                                                                ? 'bg-green-600 text-white'
                                                                : 'bg-gray-600 text-gray-300 hover:bg-gray-500'
                                                        }`}
                                                    >
                                                        <div className="font-bold">{block.number}</div>
                                                    </button>
                                                ))}
                                            </div>
                                            <p className="text-sm text-gray-400 mt-2">
                                                ØªÙ… ØªØ­Ø¯ÙŠØ¯ {(zoneBlocks[zoneId] || []).length} Ø¨Ù„ÙˆÙƒ
                                            </p>
                                        </div>
                                    ))}
                                </>
                            )}

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 py-3 rounded-lg font-bold text-gray-900"
                                    style={{ backgroundColor: 'var(--primary-gold)' }}
                                >
                                    Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== Change Password Modal ====================
        function ChangePasswordModal({ user, onClose, onSuccess }) {
            const [newPassword, setNewPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                userManager.updatePassword(user.id, newPassword);
                onSuccess();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[60]">
                    <div className="bg-gray-800 rounded-lg max-w-md w-full p-6">
                        <h3 className="text-2xl font-bold text-white mb-6">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                        <p className="text-gray-300 mb-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user.name}</p>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-white mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                                <input
                                    type="password"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    className="w-full px-4 py-3 bg-gray-700 text-white rounded-lg"
                                    required
                                />
                            </div>

                            <div className="flex gap-3">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 py-3 rounded-lg font-bold text-gray-900"
                                    style={{ backgroundColor: 'var(--primary-gold)' }}
                                >
                                    ØªØºÙŠÙŠØ±
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ==================== Zone Management Modal (Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹) ====================
        function ZoneManagementModal({ onClose }) {
            const [dynamicZones, setDynamicZones] = useState(loadDynamicZones());
            const [selectedZone, setSelectedZone] = useState(null);
            const [addBlockMode, setAddBlockMode] = useState(false);
            const [refreshKey, setRefreshKey] = useState(0);

            // Ø­Ø§Ù„Ø© Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù„ÙˆÙƒ
            const emptyType = { type: '', from: '', to: '', houses: '' };
            const [newBlockHousesTotal, setNewBlockHousesTotal] = useState('');
            const [houseTypes, setHouseTypes] = useState([{ ...emptyType }]);
            const [singleType, setSingleType] = useState(true); // Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø£Ù… Ù…ØªØ¹Ø¯Ø¯

            const manageableZones = [
                { id: 3, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù„Ø«', color: '#9333ea' },
                { id: 4, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø¹', color: '#ea580c' },
                { id: 1, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„', color: '#2563eb' },
                { id: 2, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', color: '#16a34a' },
                { id: 5, name: 'Ø§Ù„Ø²ÙˆÙ† Ø§Ù„Ø®Ø§Ù…Ø³', color: '#dc2626' },
            ];

            const resetForm = () => {
                setNewBlockHousesTotal('');
                setHouseTypes([{ ...emptyType }]);
                setSingleType(true);
                setAddBlockMode(false);
            };

            const reload = () => {
                setDynamicZones(loadDynamicZones());
                setRefreshKey(k => k + 1);
            };

            const ensureZoneExists = (zoneId, zoneName, zoneColor) => {
                const dz = loadDynamicZones();
                if (!dz[zoneId]) {
                    dz[zoneId] = {
                        id: zoneId, name: zoneName, color: zoneColor,
                        active: true, totalHouses: 0, blocks: [],
                        departments: JSON.parse(JSON.stringify(DEPARTMENTS_TEMPLATE))
                    };
                    saveDynamicZones(dz);
                }
                return dz;
            };

            const updateHouseType = (idx, field, val) => {
                setHouseTypes(prev => prev.map((t, i) => i === idx ? { ...t, [field]: val } : t));
            };

            const addHouseType = () => setHouseTypes(prev => [...prev, { ...emptyType }]);
            const removeHouseType = (idx) => setHouseTypes(prev => prev.filter((_, i) => i !== idx));

            const addBlock = (zoneInfo) => {
                const total = parseInt(newBlockHousesTotal);
                if (!total || total < 1) { alert('Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±'); return; }

                let types = [];
                if (singleType) {
                    // Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ ÙŠØºØ·ÙŠ ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±
                    const typeName = houseTypes[0]?.type?.trim();
                    types = [{ type: typeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', from: 1, to: total }];
                } else {
                    // Ø£Ù†ÙˆØ§Ø¹ Ù…ØªØ¹Ø¯Ø¯Ø© - ÙƒÙ„ Ù†ÙˆØ¹ ÙŠØ­Ø¯Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡
                    for (let i = 0; i < houseTypes.length; i++) {
                        const t = houseTypes[i];
                        const typeName = t.type?.trim();
                        if (!typeName) { alert(`Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹ Ù„Ù„ØµÙ ${i + 1}`); return; }
                        const from = parseInt(t.from);
                        const to = parseInt(t.to);
                        if (!from || !to || from < 1 || to > total || from > to) {
                            alert(`Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„ØµÙ ${i + 1}\nÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ ${total}`);
                            return;
                        }
                        types.push({ type: typeName, from, to });
                    }
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ± Ù…ØºØ·Ø§Ø©
                    const covered = new Set();
                    for (const t of types) { for (let n = t.from; n <= t.to; n++) covered.add(n); }
                    if (covered.size !== total) {
                        const missing = [];
                        for (let n = 1; n <= total; n++) { if (!covered.has(n)) missing.push(n); }
                        if (missing.length > 0) {
                            const proceed = confirm(`âš ï¸ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØºØ·Ø§Ø© Ø¨Ø£ÙŠ Ù†ÙˆØ¹: ${missing.join(', ')}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`);
                            if (!proceed) return;
                        }
                    }
                }

                const dz = ensureZoneExists(zoneInfo.id, zoneInfo.name, zoneInfo.color);
                const zone = dz[zoneInfo.id];
                const newBlockNumber = (zone.blocks.length > 0 ? Math.max(...zone.blocks.map(b => b.number)) : 0) + 1;
                zone.blocks.push({ id: newBlockNumber, number: newBlockNumber, houses: total, types });
                zone.totalHouses = zone.blocks.reduce((s, b) => s + b.houses, 0);
                dz[zoneInfo.id] = zone;
                saveDynamicZones(dz);
                resetForm();
                reload();
                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù„ÙˆÙƒ ${newBlockNumber} Ø¨Ù€ ${total} Ø¯Ø§Ø± Ù„Ù„Ø²ÙˆÙ† ${zoneInfo.name}`);
            };

            const deleteBlock = (zoneId, blockNumber) => {
                if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¨Ù„ÙˆÙƒ ${blockNumber}ØŸ`)) return;
                const dz = loadDynamicZones();
                if (!dz[zoneId]) return;
                dz[zoneId].blocks = dz[zoneId].blocks.filter(b => b.number !== blockNumber);
                dz[zoneId].blocks = dz[zoneId].blocks.map((b, i) => ({ ...b, id: i+1, number: i+1 }));
                dz[zoneId].totalHouses = dz[zoneId].blocks.reduce((s, b) => s + b.houses, 0);
                saveDynamicZones(dz);
                reload();
            };

            const currentZoneInfo = selectedZone ? manageableZones.find(z => z.id === selectedZone) : null;
            const currentZoneData = selectedZone ? (loadDynamicZones()[selectedZone] || ZONES_DATA[selectedZone]) : null;

            // Ø´Ø§Ø´Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙˆÙ†
            if (selectedZone && currentZoneInfo) {
                const isStaticZone = !!ZONES_DATA[selectedZone];
                const totalHouses = parseInt(newBlockHousesTotal) || 0;
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div className="bg-gray-800 rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                            <div className="sticky top-0 bg-gray-800 p-5 border-b border-gray-700 flex items-center justify-between">
                                <div>
                                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                        <span style={{width:14,height:14,borderRadius:'50%',background:currentZoneInfo.color,display:'inline-block'}}></span>
                                        {currentZoneInfo.name}
                                    </h3>
                                    <p className="text-gray-400 text-sm mt-1">
                                        {currentZoneData?.blocks?.length || 0} Ø¨Ù„ÙˆÙƒ | {currentZoneData?.totalHouses || 0} Ø¯Ø§Ø±
                                    </p>
                                </div>
                                <button onClick={() => { setSelectedZone(null); resetForm(); }} className="text-white text-3xl hover:text-red-500">Ã—</button>
                            </div>
                            <div className="p-5 space-y-4">
                                {!addBlockMode && (
                                    <button
                                        onClick={() => setAddBlockMode(true)}
                                        className="w-full py-3 rounded-lg font-bold text-gray-900 flex items-center justify-center gap-2"
                                        style={{backgroundColor:'var(--primary-gold)'}}
                                    >
                                        â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù„ÙˆÙƒ Ø¬Ø¯ÙŠØ¯
                                    </button>
                                )}

                                {addBlockMode && (
                                    <div className="bg-gray-700 p-4 rounded-lg space-y-4">
                                        <h4 className="text-white font-bold text-lg">â• Ø¨Ù„ÙˆÙƒ Ø¬Ø¯ÙŠØ¯</h4>

                                        {/* Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ± */}
                                        <div>
                                            <label className="text-gray-300 text-sm block mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ø¨Ù„ÙˆÙƒ <span className="text-red-400">*</span></label>
                                            <input
                                                type="number" min="1"
                                                value={newBlockHousesTotal}
                                                onChange={e => setNewBlockHousesTotal(e.target.value)}
                                                className="w-full px-3 py-2 bg-gray-600 text-white rounded-lg text-center text-lg font-bold"
                                                placeholder="Ù…Ø«Ø§Ù„: 24"
                                            />
                                        </div>

                                        {/* Ø®ÙŠØ§Ø± Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø£Ù… Ù…ØªØ¹Ø¯Ø¯ */}
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => { setSingleType(true); setHouseTypes([{ ...emptyType }]); }}
                                                className="flex-1 py-2 rounded-lg text-sm font-bold transition"
                                                style={singleType ? {backgroundColor:'var(--primary-gold)',color:'#111'} : {backgroundColor:'#4b5563',color:'#fff'}}
                                            >Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯</button>
                                            <button
                                                onClick={() => { setSingleType(false); setHouseTypes([{ ...emptyType }, { ...emptyType }]); }}
                                                className="flex-1 py-2 rounded-lg text-sm font-bold transition"
                                                style={!singleType ? {backgroundColor:'var(--primary-gold)',color:'#111'} : {backgroundColor:'#4b5563',color:'#fff'}}
                                            >Ø£Ù†ÙˆØ§Ø¹ Ù…ØªØ¹Ø¯Ø¯Ø©</button>
                                        </div>

                                        {/* Ù†ÙˆØ¹ ÙˆØ§Ø­Ø¯ */}
                                        {singleType && (
                                            <div>
                                                <label className="text-gray-300 text-sm block mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø§Ø± <span className="text-gray-400">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span></label>
                                                <input
                                                    type="text"
                                                    value={houseTypes[0]?.type || ''}
                                                    onChange={e => updateHouseType(0, 'type', e.target.value)}
                                                    className="w-full px-3 py-2 bg-gray-600 text-white rounded-lg"
                                                    placeholder="Ù…Ø«Ø§Ù„: VY Ø£Ùˆ A1 Ø£Ùˆ ÙÙŠÙ„Ø§ Ø£Ùˆ Ø£ÙŠ ØªØ³Ù…ÙŠØ©..."
                                                />
                                                {totalHouses > 0 && (
                                                    <p className="text-gray-400 text-xs mt-1">Ø³ÙŠÙØ·Ø¨ÙÙ‘Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ± Ù…Ù† 1 Ø¥Ù„Ù‰ {totalHouses}</p>
                                                )}
                                            </div>
                                        )}

                                        {/* Ø£Ù†ÙˆØ§Ø¹ Ù…ØªØ¹Ø¯Ø¯Ø© */}
                                        {!singleType && (
                                            <div className="space-y-3">
                                                <div className="flex items-center justify-between">
                                                    <label className="text-gray-300 text-sm font-bold">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¯ÙˆØ± ÙˆØ£Ø±Ù‚Ø§Ù…Ù‡Ø§</label>
                                                    {totalHouses > 0 && <span className="text-gray-400 text-xs">Ø§Ù„Ø¯ÙˆØ±: 1 â†’ {totalHouses}</span>}
                                                </div>
                                                {houseTypes.map((t, idx) => (
                                                    <div key={idx} className="bg-gray-600 p-3 rounded-lg space-y-2">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-gray-300 text-xs font-bold">Ø§Ù„Ù†ÙˆØ¹ {idx + 1}</span>
                                                            {houseTypes.length > 1 && (
                                                                <button onClick={() => removeHouseType(idx)} className="text-red-400 hover:text-red-300 text-sm">âœ• Ø­Ø°Ù</button>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <label className="text-gray-400 text-xs block mb-1">Ø§Ø³Ù… Ø§Ù„Ù†ÙˆØ¹</label>
                                                            <input
                                                                type="text"
                                                                value={t.type}
                                                                onChange={e => updateHouseType(idx, 'type', e.target.value)}
                                                                className="w-full px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
                                                                placeholder="Ù…Ø«Ø§Ù„: VY Ø£Ùˆ VK Ø£Ùˆ ÙÙŠÙ„Ø§..."
                                                            />
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <div className="flex-1">
                                                                <label className="text-gray-400 text-xs block mb-1">Ù…Ù† Ø¯Ø§Ø± Ø±Ù‚Ù…</label>
                                                                <input
                                                                    type="number" min="1"
                                                                    value={t.from}
                                                                    onChange={e => updateHouseType(idx, 'from', e.target.value)}
                                                                    className="w-full px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
                                                                    placeholder="1"
                                                                />
                                                            </div>
                                                            <div className="flex-1">
                                                                <label className="text-gray-400 text-xs block mb-1">Ø¥Ù„Ù‰ Ø¯Ø§Ø± Ø±Ù‚Ù…</label>
                                                                <input
                                                                    type="number" min="1"
                                                                    value={t.to}
                                                                    onChange={e => updateHouseType(idx, 'to', e.target.value)}
                                                                    className="w-full px-3 py-2 bg-gray-500 text-white rounded-lg text-sm"
                                                                    placeholder={totalHouses || '?'}
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                <button
                                                    onClick={addHouseType}
                                                    className="w-full py-2 border-2 border-dashed border-gray-500 text-gray-400 rounded-lg hover:border-yellow-500 hover:text-yellow-500 transition text-sm"
                                                >
                                                    â• Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø¢Ø®Ø±
                                                </button>
                                            </div>
                                        )}

                                        <div className="flex gap-3 pt-2">
                                            <button onClick={resetForm} className="flex-1 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Ø¥Ù„ØºØ§Ø¡</button>
                                            <button onClick={() => addBlock(currentZoneInfo)} className="flex-1 py-3 rounded-lg font-bold text-gray-900" style={{backgroundColor:'var(--primary-gold)'}}>
                                                âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù„ÙˆÙƒ
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-2">
                                    <h4 className="text-white font-bold text-sm">Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
                                    {(!currentZoneData?.blocks || currentZoneData.blocks.length === 0) ? (
                                        <div className="text-center py-8 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„ÙˆÙƒØ§Øª Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ø¨Ù„ÙˆÙƒ Ø¬Ø¯ÙŠØ¯" Ù„Ù„Ø¨Ø¯Ø¡</div>
                                    ) : (
                                        currentZoneData.blocks.map(block => (
                                            <div key={block.number} className="bg-gray-700 p-3 rounded-lg">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="flex items-center gap-2 flex-wrap">
                                                        <span className="text-white font-bold">Ø¨Ù„ÙˆÙƒ {block.number}</span>
                                                        <span className="text-gray-400 text-sm">{block.houses} Ø¯Ø§Ø±</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {!isStaticZone && (
                                                            <button
                                                                onClick={() => deleteBlock(selectedZone, block.number)}
                                                                className="px-2 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                                                                title="Ø­Ø°Ù Ø§Ù„Ø¨Ù„ÙˆÙƒ"
                                                            >ğŸ—‘ï¸</button>
                                                        )}
                                                        {isStaticZone && (
                                                            <span className="text-gray-500 text-xs italic">Ø«Ø§Ø¨Øª</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex flex-wrap gap-1">
                                                    {block.types?.map((t, i) => (
                                                        <span key={i} className="text-xs px-2 py-0.5 rounded" style={{background:'rgba(201,169,97,0.2)',color:'var(--primary-gold)'}}>
                                                            {t.type}{t.from && t.to && t.from !== 1 || t.to !== block.houses ? ` (${t.from}â€“${t.to})` : ''}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Ø´Ø§Ø´Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²ÙˆÙ†Ø§Øª
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="sticky top-0 bg-gray-800 p-5 border-b border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-white">ğŸ—ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø¨Ù„ÙˆÙƒØ§Øª</h3>
                                <p className="text-gray-400 text-sm mt-1">Ø¥Ø¶Ø§ÙØ© Ø¨Ù„ÙˆÙƒØ§Øª ÙˆØ¯ÙˆØ± Ù„Ù„Ø²ÙˆÙ†Ø§Øª</p>
                            </div>
                            <button onClick={onClose} className="text-white text-3xl hover:text-red-500">Ã—</button>
                        </div>
                        <div className="p-5 space-y-3">
                            {manageableZones.map(zone => {
                                const zd = dynamicZones[zone.id] || ZONES_DATA[zone.id];
                                const blocksCount = zd?.blocks?.length || 0;
                                const housesCount = zd?.totalHouses || 0;
                                const isNew = !ZONES_DATA[zone.id];
                                return (
                                    <button
                                        key={zone.id}
                                        onClick={() => { setSelectedZone(zone.id); setAddBlockMode(false); }}
                                        className="w-full p-4 rounded-xl text-right flex items-center justify-between hover:opacity-90 transition"
                                        style={{background:'#1f2937', border:`2px solid ${zone.color}40`}}
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold"
                                                style={{background:`${zone.color}30`, border:`2px solid ${zone.color}`}}>
                                                {zone.id}
                                            </div>
                                            <div className="text-right">
                                                <div className="text-white font-bold">{zone.name}</div>
                                                <div className="text-gray-400 text-sm">
                                                    {blocksCount > 0 ? `${blocksCount} Ø¨Ù„ÙˆÙƒ | ${housesCount} Ø¯Ø§Ø±` : 'Ù„Ù… ØªÙØ¶Ù Ø¨Ù„ÙˆÙƒØ§Øª Ø¨Ø¹Ø¯'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {isNew && blocksCount === 0 && (
                                                <span className="text-xs px-2 py-1 rounded-full" style={{background:'rgba(201,169,97,0.2)',color:'var(--primary-gold)'}}>Ø¬Ø¯ÙŠØ¯</span>
                                            )}
                                            {blocksCount > 0 && (
                                                <span className="text-xs px-2 py-1 rounded-full bg-green-900 text-green-300">Ù†Ø´Ø·</span>
                                            )}
                                            <span className="text-gray-400 text-xl">â†</span>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== Render App ====================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <!-- ===== PWA Install Banner ===== -->
    <div id="pwa-install-banner" style="display:none;">
        <div class="pwa-icon">AL</div>
        <div class="pwa-text">
            <div class="pwa-title">Ø«Ø¨Ù‘Øª ØªØ·Ø¨ÙŠÙ‚ ALFARAH</div>
            <div class="pwa-sub" id="pwa-install-hint">Ø§Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</div>
        </div>
        <button class="pwa-btn" id="pwa-install-btn">ØªØ«Ø¨ÙŠØª</button>
        <button class="pwa-close" id="pwa-close-btn">Ã—</button>
    </div>

    <!-- ===== Service Worker ===== -->
    <script>
        // ---- Service Worker ----
        const SW_CODE = `
const CACHE = 'alfarah-v1';
const ASSETS = [
    './',
    'https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap',
    'https://unpkg.com/react@18/umd/react.production.min.js',
    'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
    'https://unpkg.com/@babel/standalone/babel.min.js',
    'https://cdn.tailwindcss.com'
];

self.addEventListener('install', e => {
    e.waitUntil(
        caches.open(CACHE).then(c => {
            // Cache main page only (CDN assets may fail due to CORS)
            return c.add('./').catch(() => {});
        })
    );
    self.skipWaiting();
});

self.addEventListener('activate', e => {
    e.waitUntil(
        caches.keys().then(keys =>
            Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
        )
    );
    self.clients.claim();
});

self.addEventListener('fetch', e => {
    // Ù„Ù„Ù€ Firebase - Ù„Ø§ Ù†Ø¹ØªØ±Ø¶Ù‡
    if (e.request.url.includes('firebaseio.com') || 
        e.request.url.includes('googleapis.com/identitytoolkit')) {
        return;
    }
    e.respondWith(
        caches.match(e.request).then(cached => {
            if (cached) return cached;
            return fetch(e.request).then(res => {
                if (res && res.status === 200 && res.type === 'basic') {
                    const clone = res.clone();
                    caches.open(CACHE).then(c => c.put(e.request, clone));
                }
                return res;
            }).catch(() => cached || new Response('offline', {status: 503}));
        })
    );
});
`;

        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            const swBlob = new Blob([SW_CODE], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swURL, {scope: './'})
                .then(reg => console.log('âœ… SW registered'))
                .catch(err => console.warn('SW registration failed (normal in some browsers):', err));
        }

        // ---- PWA Install Prompt ----
        let deferredPrompt = null;
        const banner = document.getElementById('pwa-install-banner');
        const installBtn = document.getElementById('pwa-install-btn');
        const closeBtn = document.getElementById('pwa-close-btn');
        const hint = document.getElementById('pwa-install-hint');

        // Android / Chrome - Ø­Ø¯Ø« Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            banner.style.display = 'flex';
            hint.textContent = 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ';
        });

        // iOS Safari - Ø¹Ø±Ø¶ ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙŠØ¯ÙˆÙŠØ©
        const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        if (isIOS && isSafari && !isStandalone) {
            setTimeout(() => {
                banner.style.display = 'flex';
                hint.textContent = 'Share â† Add to Home Screen';
                installBtn.textContent = 'ÙƒÙŠÙØŸ';
                installBtn.onclick = () => {
                    alert('Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ iPhone:\n\n1ï¸âƒ£ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© â†‘ Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©\n2ï¸âƒ£ Ø§Ø®ØªØ± "Add to Home Screen"\n3ï¸âƒ£ Ø§Ø¶ØºØ· "Add"\n\nØ³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø´Ø§Ø´ØªÙƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙƒØ£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø§Ø¯ÙŠ');
                };
            }, 3000);
        }

        installBtn && installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                banner.style.display = 'none';
            }
        });

        closeBtn && closeBtn.addEventListener('click', () => {
            banner.style.display = 'none';
        });

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ù†Ø± Ø¥Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø«Ø¨Øª Ø¨Ø§Ù„ÙØ¹Ù„
        if (isStandalone) {
            banner.style.display = 'none';
        }
    </script>
</body>
</html>
